!function(r,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(r.MMTF=r.MMTF||{})}(this,function(r){"use strict";function t(r,t,e){for(var n=(r.byteLength,0),i=e.length;i>n;n++){var o=e.charCodeAt(n);if(128>o)r.setUint8(t++,o>>>0&127|0);else if(2048>o)r.setUint8(t++,o>>>6&31|192),r.setUint8(t++,o>>>0&63|128);else if(65536>o)r.setUint8(t++,o>>>12&15|224),r.setUint8(t++,o>>>6&63|128),r.setUint8(t++,o>>>0&63|128);else{if(!(1114112>o))throw new Error("bad codepoint "+o);r.setUint8(t++,o>>>18&7|240),r.setUint8(t++,o>>>12&63|128),r.setUint8(t++,o>>>6&63|128),r.setUint8(t++,o>>>0&63|128)}}}function e(r){for(var t=0,e=0,n=r.length;n>e;e++){var i=r.charCodeAt(e);if(128>i)t+=1;else if(2048>i)t+=2;else if(65536>i)t+=3;else{if(!(1114112>i))throw new Error("bad codepoint "+i);t+=4}}return t}function n(r,i,o){var a=typeof r;if("string"===a){var s=e(r);if(32>s)return i.setUint8(o,160|s),t(i,o+1,r),1+s;if(256>s)return i.setUint8(o,217),i.setUint8(o+1,s),t(i,o+2,r),2+s;if(65536>s)return i.setUint8(o,218),i.setUint16(o+1,s),t(i,o+3,r),3+s;if(4294967296>s)return i.setUint8(o,219),i.setUint32(o+1,s),t(i,o+5,r),5+s}if(r instanceof ArrayBuffer){var s=r.byteLength;if(256>s)return i.setUint8(o,196),i.setUint8(o+1,s),new Uint8Array(i.buffer).set(new Uint8Array(r),o+2),2+s;if(65536>s)return i.setUint8(o,197),i.setUint16(o+1,s),new Uint8Array(i.buffer).set(new Uint8Array(r),o+3),3+s;if(4294967296>s)return i.setUint8(o,198),i.setUint32(o+1,s),new Uint8Array(i.buffer).set(new Uint8Array(r),o+5),5+s}if("number"===a){if(!isFinite(r))throw new Error("Number not finite: "+r);if(Math.floor(r)!==r)return i.setUint8(o,203),i.setFloat64(o+1,r),9;if(r>=0){if(128>r)return i.setUint8(o,r),1;if(256>r)return i.setUint8(o,204),i.setUint8(o+1,r),2;if(65536>r)return i.setUint8(o,205),i.setUint16(o+1,r),3;if(4294967296>r)return i.setUint8(o,206),i.setUint32(o+1,r),5;throw new Error("Number too big 0x"+r.toString(16))}if(r>=-32)return i.setInt8(o,r),1;if(r>=-128)return i.setUint8(o,208),i.setInt8(o+1,r),2;if(r>=-32768)return i.setUint8(o,209),i.setInt16(o+1,r),3;if(r>=-2147483648)return i.setUint8(o,210),i.setInt32(o+1,r),5;throw new Error("Number too small -0x"+(-r).toString(16).substr(1))}if(null===r)return i.setUint8(o,192),1;if("boolean"===a)return i.setUint8(o,r?195:194),1;if("object"===a){var s,u=0,f=Array.isArray(r);if(f)s=r.length;else{var c=Object.keys(r);s=c.length}var u;if(16>s?(i.setUint8(o,s|(f?144:128)),u=1):65536>s?(i.setUint8(o,f?220:222),i.setUint16(o+1,s),u=3):4294967296>s&&(i.setUint8(o,f?221:223),i.setUint32(o+1,s),u=5),f)for(var d=0;s>d;d++)u+=n(r[d],i,o+u);else for(var d=0;s>d;d++){var l=c[d];u+=n(l,i,o+u),u+=n(r[l],i,o+u)}return u}throw new Error("Unknown type "+a)}function i(r){var t=typeof r;if("string"===t){var n=e(r);if(32>n)return 1+n;if(256>n)return 2+n;if(65536>n)return 3+n;if(4294967296>n)return 5+n}if(r instanceof ArrayBuffer){var n=r.byteLength;if(256>n)return 2+n;if(65536>n)return 3+n;if(4294967296>n)return 5+n}if("number"===t){if(Math.floor(r)!==r)return 9;if(r>=0){if(128>r)return 1;if(256>r)return 2;if(65536>r)return 3;if(4294967296>r)return 5;throw new Error("Number too big 0x"+r.toString(16))}if(r>=-32)return 1;if(r>=-128)return 2;if(r>=-32768)return 3;if(r>=-2147483648)return 5;throw new Error("Number too small -0x"+r.toString(16).substr(1))}if("boolean"===t||null===r)return 1;if("object"===t){var n,o=0;if(Array.isArray(r)){n=r.length;for(var a=0;n>a;a++)o+=i(r[a])}else{var s=Object.keys(r);n=s.length;for(var a=0;n>a;a++){var u=s[a];o+=i(u)+i(r[u])}}if(16>n)return 1+o;if(65536>n)return 3+o;if(4294967296>n)return 5+o;throw new Error("Array or object too long 0x"+n.toString(16))}throw new Error("Unknown type "+t)}function o(r){var t=new ArrayBuffer(i(r)),e=new DataView(t);return n(r,e,0),new Uint8Array(t)}function a(r){return new Uint8Array(r.buffer,r.byteOffset,r.byteLength)}function s(r){return new Int8Array(r.buffer,r.byteOffset,r.byteLength)}function u(r,t){var e,n,i,o=(r.byteOffset,r.byteLength);for(t||(t=new Int16Array(o/2)),e=0,n=0,i=o/2;i>e;++e,n+=2)t[e]=r[n]<<8^r[n+1]<<0;return t}function f(r,t){var e=r.length;t||(t=new Uint8Array(2*e));for(var n=new DataView(t.buffer,t.byteOffset,t.byteLength),i=0;e>i;++i)n.setInt16(2*i,r[i]);return t.buffer}function c(r,t){var e,n,i,o=(r.byteOffset,r.byteLength);for(t||(t=new Int32Array(o/4)),e=0,n=0,i=o/4;i>e;++e,n+=4)t[e]=r[n]<<24^r[n+1]<<16^r[n+2]<<8^r[n+3]<<0;return t}function d(r){return new Int32Array(r.buffer,r.byteOffset,r.byteLength/4)}function l(r,t){var e=r.length;t||(t=new Uint8Array(4*e));for(var n=new DataView(t.buffer,t.byteOffset,t.byteLength),i=0;e>i;++i)n.setInt32(4*i,r[i]);return t.buffer}function y(r,t,e){var n=r.length,i=1/t;e||(e=new Float32Array(n));for(var o=0;n>o;++o)e[o]=r[o]*i;return e}function g(r,t,e,n){e||(e=4);var i=r.length,o=new ArrayBuffer(i*e),a=new DataView(o),s="setInt32";1===e?s="setInt8":2===e&&(s="setInt16");for(var u=0;i>u;++u)a[s](e*u,Math.round(r[u]*t),n);return o}function L(r,t){var e,n;if(!t){var i=0;for(e=0,n=r.length;n>e;e+=2)i+=r[e+1];t=new r.constructor(i)}var o=0;for(e=0,n=r.length;n>e;e+=2)for(var a=r[e],s=r[e+1],u=0;s>u;++u)t[o]=a,o+=1;return t}function h(r){if(0===r.length)return new ArrayBuffer;var t,e,n=2;for(t=1,e=r.length;e>t;++t)r[t-1]!==r[t]&&(n+=2);var i=new ArrayBuffer(4*n),o=new DataView(i),a=0,s=1;for(t=1,e=r.length;e>t;++t)r[t-1]!==r[t]?(o.setInt32(a,r[t-1]),o.setInt32(a+4,s),s=1,a+=8):s+=1;return o.setInt32(a,r[r.length-1]),o.setInt32(a+4,s),i}function v(r){for(var t=1,e=r.length;e>t;++t)r[t]+=r[t-1];return r}function w(r,t){t||(t=new r.constructor(r.length)),t[0]=r[0];for(var e=1,n=t.length;n>e;++e)t[e]=r[e]-r[e-1];return t}function U(r,t,e){var n=r.length/2+t.length;e||(e=new Int32Array(n));for(var i=0,o=0,a=0,s=r.length;s>a;a+=2){var u=r[a],f=r[a+1];e[i]=u,0!==a&&(e[i]+=e[i-1]),i+=1;for(var c=0;f>c;++c)e[i]=e[i-1]+t[o],i+=1,o+=1}return e}function b(r,t){if(0===r.length)return[new ArrayBuffer,new ArrayBuffer];var e,n,i=t?127:32767,o=t?Int8Array:Int16Array,a=w(r),s=2,u=0;for(e=1,n=a.length;n>e;++e){var c=a[e];c>i||-i>c?s+=2:u+=1}var d=new Int32Array(s),y=new o(u),g=0,L=0;for(d[g]=a[0],d[g+1]=0,g+=2,e=1,n=a.length;n>e;++e){var c=a[e];c>i||-i>c?(d[g]=c,d[g+1]=0,g+=2):(y[L]=c,L+=1,d[g-1]+=1)}return[l(d,d),t?y:f(y,y)]}function m(r,t,e,n){var i=r.length/4/2+t.length/2;n||(n=new Float32Array(i));var o=d(n),a=U(c(r),u(t),o);return y(a,e,n)}function A(r,t,e){var n=new Int32Array(g(r,t,4,!0));return b(n,e)}function p(r,t,e){var n=e?d(e):void 0,i=L(c(r),n);return y(i,t,e)}function I(r){var t={};N.forEach(function(e){void 0!==r[e]&&(t[e]=r[e])}),r.bondAtomList&&(t.bondAtomList=new Uint8Array(l(r.bondAtomList))),r.bondOrderList&&(t.bondOrderList=new Uint8Array(r.bondOrderList.buffer));var e=A(r.xCoordList,1e3);t.xCoordBig=new Uint8Array(e[0]),t.xCoordSmall=new Uint8Array(e[1]);var n=A(r.yCoordList,1e3);t.yCoordBig=new Uint8Array(n[0]),t.yCoordSmall=new Uint8Array(n[1]);var i=A(r.zCoordList,1e3);if(t.zCoordBig=new Uint8Array(i[0]),t.zCoordSmall=new Uint8Array(i[1]),r.bFactorList){var o=A(r.bFactorList,100);t.bFactorBig=new Uint8Array(o[0]),t.bFactorSmall=new Uint8Array(o[1])}return r.atomIdList&&(t.atomIdList=new Uint8Array(h(w(r.atomIdList)))),r.altLocList&&(t.altLocList=new Uint8Array(h(r.altLocList))),r.occupancyList&&(t.occupancyList=new Uint8Array(h(new Int32Array(g(r.occupancyList,100,4,!0))))),t.groupIdList=new Uint8Array(h(w(r.groupIdList))),t.groupTypeList=new Uint8Array(l(r.groupTypeList)),r.secStructList&&(t.secStructList=new Uint8Array(r.secStructList.buffer)),r.insCodeList&&(t.insCodeList=new Uint8Array(h(r.insCodeList))),r.sequenceIndexList&&(t.sequenceIndexList=new Uint8Array(h(w(r.sequenceIndexList)))),t.chainIdList=new Uint8Array(r.chainIdList.buffer),r.chainNameList&&(t.chainNameList=new Uint8Array(r.chainNameList.buffer)),t}function C(r){function t(r){for(var t={},e=0;r>e;e++){var n=o();t[n]=o()}return t}function e(t){var e=r.subarray(a,a+t);return a+=t,e}function n(t){var e=r.subarray(a,a+t);a+=t;var n=65535;if(t>n){for(var i=[],o=0;o<e.length;o+=n)i.push(String.fromCharCode.apply(null,e.subarray(o,o+n)));return i.join("")}return String.fromCharCode.apply(null,e)}function i(r){for(var t=new Array(r),e=0;r>e;e++)t[e]=o();return t}function o(){var o,u,f=r[a];if(0===(128&f))return a++,f;if(128===(240&f))return u=15&f,a++,t(u);if(144===(240&f))return u=15&f,a++,i(u);if(160===(224&f))return u=31&f,a++,n(u);if(224===(224&f))return o=s.getInt8(a),a++,o;switch(f){case 192:return a++,null;case 194:return a++,!1;case 195:return a++,!0;case 196:return u=s.getUint8(a+1),a+=2,e(u);case 197:return u=s.getUint16(a+1),a+=3,e(u);case 198:return u=s.getUint32(a+1),a+=5,e(u);case 202:return o=s.getFloat32(a+1),a+=5,o;case 203:return o=s.getFloat64(a+1),a+=9,o;case 204:return o=r[a+1],a+=2,o;case 205:return o=s.getUint16(a+1),a+=3,o;case 206:return o=s.getUint32(a+1),a+=5,o;case 208:return o=s.getInt8(a+1),a+=2,o;case 209:return o=s.getInt16(a+1),a+=3,o;case 210:return o=s.getInt32(a+1),a+=5,o;case 217:return u=s.getUint8(a+1),a+=2,n(u);case 218:return u=s.getUint16(a+1),a+=3,n(u);case 219:return u=s.getUint32(a+1),a+=5,n(u);case 220:return u=s.getUint16(a+1),a+=3,i(u);case 221:return u=s.getUint32(a+1),a+=5,i(u);case 222:return u=s.getUint16(a+1),a+=3,t(u);case 223:return u=s.getUint32(a+1),a+=5,t(u)}throw new Error("Unknown type 0x"+f.toString(16))}var a=0,s=new DataView(r.buffer);return o()}function x(r,t){function e(r){return n?-1===n.indexOf(r):!0}t=t||{};var n=t.ignoreFields,i=(r.numBonds||0,r.numAtoms||0),o=r.groupTypeList.length/4,u=r.chainIdList.length/4,f=r.chainsPerModel.length,d={numGroups:o,numChains:u,numModels:f};N.forEach(function(t){void 0!==r[t]&&(d[t]=r[t])});var l="bondAtomList";r[l]&&e(l)&&(d[l]=c(r[l]));var y="bondOrderList";r[y]&&e(y)&&(d[y]=a(r[y])),d.xCoordList=m(r.xCoordBig,r.xCoordSmall,1e3),d.yCoordList=m(r.yCoordBig,r.yCoordSmall,1e3),d.zCoordList=m(r.zCoordBig,r.zCoordSmall,1e3);var g="bFactorList",h="bFactorBig",w="bFactorSmall";r[h]&&r[w]&&e(g)&&(d[g]=m(r[h],r[w],100));var U="atomIdList";r[U]&&e(U)&&(d[U]=v(L(c(r[U]))));var b="altLocList";r[b]&&e(b)&&(d[b]=L(c(r[b]),new Uint8Array(i)));var A="occupancyList";r[A]&&e(A)&&(d[A]=p(r[A],100)),d.groupIdList=v(L(c(r.groupIdList))),d.groupTypeList=c(r.groupTypeList);var I="secStructList";r[I]&&e(I)&&(d[I]=s(r[I]));var C="insCodeList";r[C]&&e(C)&&(d[C]=L(c(r[C]),new Uint8Array(o)));var x="sequenceIndexList";r[x]&&e(x)&&(d[x]=v(L(c(r[x])))),d.chainIdList=a(r.chainIdList);var S="chainNameList";return r[S]&&e(S)&&(d[S]=a(r[S])),d}function S(r){return String.fromCharCode.apply(null,r).replace(/\0/g,"")}function B(r,t,e){e=e||{};var n,i,o,a,s,u,f=e.firstModelOnly,c=t.onModel,d=t.onChain,l=t.onGroup,y=t.onAtom,g=t.onBond,L=0,h=0,v=0,w=0,U=0,b=-1,m=r.chainNameList,A=r.secStructList,p=r.insCodeList,I=r.sequenceIndexList,C=r.atomIdList,x=r.bFactorList,B=r.altLocList,O=r.occupancyList,F=r.bondAtomList,N=r.bondOrderList;for(n=0,i=r.chainsPerModel.length;i>n&&!(f&&L>0);++n){var M=r.chainsPerModel[L];for(c&&c({chainCount:M,modelIndex:L}),o=0;M>o;++o){var E=r.groupsPerChain[h];if(d){var T=S(r.chainIdList.subarray(4*h,4*h+4)),z=null;m&&(z=S(m.subarray(4*h,4*h+4))),d({groupCount:E,chainIndex:h,modelIndex:L,chainId:T,chainName:z})}for(a=0;E>a;++a){var D=r.groupList[r.groupTypeList[v]],j=D.atomNameList.length;if(l){var P=null;A&&(P=A[v]);var V=null;r.insCodeList&&(V=String.fromCharCode(p[v]));var k=null;I&&(k=I[v]),l({atomCount:j,groupIndex:v,chainIndex:h,modelIndex:L,groupId:r.groupIdList[v],groupType:r.groupTypeList[v],groupName:D.groupName,singleLetterCode:D.singleLetterCode,chemCompType:D.chemCompType,secStruct:P,insCode:V,sequenceIndex:k})}for(s=0;j>s;++s){if(y){var q=null;C&&(q=C[w]);var G=null;x&&(G=x[w]);var W=null;B&&(W=String.fromCharCode(B[w]));var H=null;O&&(H=O[w]),y({atomIndex:w,groupIndex:v,chainIndex:h,modelIndex:L,atomId:q,element:D.elementList[s],atomName:D.atomNameList[s],atomCharge:D.atomChargeList[s],xCoord:r.xCoordList[w],yCoord:r.yCoordList[w],zCoord:r.zCoordList[w],bFactor:G,altLoc:W,occupancy:H})}w+=1}if(g){var J=D.bondAtomList;for(s=0,u=D.bondOrderList.length;u>s;++s)g({atomIndex1:w-j+J[2*s],atomIndex2:w-j+J[2*s+1],bondOrder:D.bondOrderList[s]})}v+=1}h+=1}if(U=b+1,b=w-1,g&&F)for(s=0,u=F.length;u>s;s+=2){var K=F[s],Q=F[s+1];(K>=U&&b>=K||Q>=U&&b>=Q)&&g({atomIndex1:K,atomIndex2:Q,bondOrder:N?N[s/2]:null})}L+=1}}function O(r){return o(I(r))}function F(r,t){r instanceof ArrayBuffer&&(r=new Uint8Array(r));var e;return e=r instanceof Uint8Array?C(r):r,x(e,t)}var N=["mmtfVersion","mmtfProducer","unitCell","spaceGroup","structureId","title","depositionDate","releaseDate","experimentalMethods","resolution","rFree","rWork","bioAssemblyList","entityList","groupList","numBonds","numAtoms","groupsPerChain","chainsPerModel"],M="v0.2.3";r.encode=O,r.decode=F,r.traverse=B,r.version=M});