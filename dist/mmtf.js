!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r(t.MMTF=t.MMTF||{})}(this,function(t){"use strict";function r(t,r,n){for(var e=(t.byteLength,0),i=n.length;i>e;e++){var o=n.charCodeAt(e);if(128>o)t.setUint8(r++,o>>>0&127|0);else if(2048>o)t.setUint8(r++,o>>>6&31|192),t.setUint8(r++,o>>>0&63|128);else if(65536>o)t.setUint8(r++,o>>>12&15|224),t.setUint8(r++,o>>>6&63|128),t.setUint8(r++,o>>>0&63|128);else{if(!(1114112>o))throw new Error("bad codepoint "+o);t.setUint8(r++,o>>>18&7|240),t.setUint8(r++,o>>>12&63|128),t.setUint8(r++,o>>>6&63|128),t.setUint8(r++,o>>>0&63|128)}}}function n(t){for(var r=0,n=0,e=t.length;e>n;n++){var i=t.charCodeAt(n);if(128>i)r+=1;else if(2048>i)r+=2;else if(65536>i)r+=3;else{if(!(1114112>i))throw new Error("bad codepoint "+i);r+=4}}return r}function e(t,i,o){var u=typeof t;if("string"===u){var a=n(t);if(32>a)return i.setUint8(o,160|a),r(i,o+1,t),1+a;if(256>a)return i.setUint8(o,217),i.setUint8(o+1,a),r(i,o+2,t),2+a;if(65536>a)return i.setUint8(o,218),i.setUint16(o+1,a),r(i,o+3,t),3+a;if(4294967296>a)return i.setUint8(o,219),i.setUint32(o+1,a),r(i,o+5,t),5+a}if(t instanceof Uint8Array){var a=t.byteLength,s=new Uint8Array(i.buffer);if(256>a)return i.setUint8(o,196),i.setUint8(o+1,a),s.set(t,o+2),2+a;if(65536>a)return i.setUint8(o,197),i.setUint16(o+1,a),s.set(t,o+3),3+a;if(4294967296>a)return i.setUint8(o,198),i.setUint32(o+1,a),s.set(t,o+5),5+a}if("number"===u){if(!isFinite(t))throw new Error("Number not finite: "+t);if(Math.floor(t)!==t)return i.setUint8(o,203),i.setFloat64(o+1,t),9;if(t>=0){if(128>t)return i.setUint8(o,t),1;if(256>t)return i.setUint8(o,204),i.setUint8(o+1,t),2;if(65536>t)return i.setUint8(o,205),i.setUint16(o+1,t),3;if(4294967296>t)return i.setUint8(o,206),i.setUint32(o+1,t),5;throw new Error("Number too big 0x"+t.toString(16))}if(t>=-32)return i.setInt8(o,t),1;if(t>=-128)return i.setUint8(o,208),i.setInt8(o+1,t),2;if(t>=-32768)return i.setUint8(o,209),i.setInt16(o+1,t),3;if(t>=-2147483648)return i.setUint8(o,210),i.setInt32(o+1,t),5;throw new Error("Number too small -0x"+(-t).toString(16).substr(1))}if(null===t)return i.setUint8(o,192),1;if("boolean"===u)return i.setUint8(o,t?195:194),1;if("object"===u){var a,f=0,c=Array.isArray(t);if(c)a=t.length;else{var d=Object.keys(t);a=d.length}var f;if(16>a?(i.setUint8(o,a|(c?144:128)),f=1):65536>a?(i.setUint8(o,c?220:222),i.setUint16(o+1,a),f=3):4294967296>a&&(i.setUint8(o,c?221:223),i.setUint32(o+1,a),f=5),c)for(var l=0;a>l;l++)f+=e(t[l],i,o+f);else for(var l=0;a>l;l++){var g=d[l];f+=e(g,i,o+f),f+=e(t[g],i,o+f)}return f}throw new Error("Unknown type "+u)}function i(t){var r=typeof t;if("string"===r){var e=n(t);if(32>e)return 1+e;if(256>e)return 2+e;if(65536>e)return 3+e;if(4294967296>e)return 5+e}if(t instanceof Uint8Array){var e=t.byteLength;if(256>e)return 2+e;if(65536>e)return 3+e;if(4294967296>e)return 5+e}if("number"===r){if(Math.floor(t)!==t)return 9;if(t>=0){if(128>t)return 1;if(256>t)return 2;if(65536>t)return 3;if(4294967296>t)return 5;throw new Error("Number too big 0x"+t.toString(16))}if(t>=-32)return 1;if(t>=-128)return 2;if(t>=-32768)return 3;if(t>=-2147483648)return 5;throw new Error("Number too small -0x"+t.toString(16).substr(1))}if("boolean"===r||null===t)return 1;if("object"===r){var e,o=0;if(Array.isArray(t)){e=t.length;for(var u=0;e>u;u++)o+=i(t[u])}else{var a=Object.keys(t);e=a.length;for(var u=0;e>u;u++){var s=a[u];o+=i(s)+i(t[s])}}if(16>e)return 1+o;if(65536>e)return 3+o;if(4294967296>e)return 5+o;throw new Error("Array or object too long 0x"+e.toString(16))}throw new Error("Unknown type "+r)}function o(t){var r=new ArrayBuffer(i(t)),n=new DataView(r);return e(t,n,0),new Uint8Array(r)}function u(t,r,n){return r?new t(r.buffer,r.byteOffset,r.byteLength/(n||1)):void 0}function a(t){return u(DataView,t)}function s(t){return u(Uint8Array,t)}function f(t){return u(Int8Array,t)}function c(t){return u(Int32Array,t,4)}function d(t){return u(Float32Array,t,4)}function l(t,r){var n=t.length/2;r||(r=new Int16Array(n));for(var e=0,i=0;n>e;++e,i+=2)r[e]=t[i]<<8^t[i+1]<<0;return r}function g(t,r){var n=t.length;r||(r=new Uint8Array(2*n));for(var e=a(r),i=0;n>i;++i)e.setInt16(2*i,t[i]);return s(r)}function v(t,r){var n=t.length/4;r||(r=new Int32Array(n));for(var e=0,i=0;n>e;++e,i+=4)r[e]=t[i]<<24^t[i+1]<<16^t[i+2]<<8^t[i+3]<<0;return r}function L(t,r){var n=t.length;r||(r=new Uint8Array(4*n));for(var e=a(r),i=0;n>i;++i)e.setInt32(4*i,t[i]);return s(r)}function h(t,r){var n=t.length;r||(r=new Float32Array(n/4));for(var e=a(r),i=a(t),o=0,u=0,s=n/4;s>o;++o,u+=4)e.setFloat32(u,i.getFloat32(u),!0);return r}function y(t,r,n){var e=t.length,i=1/r;n||(n=new Float32Array(e));for(var o=0;e>o;++o)n[o]=t[o]*i;return n}function m(t,r,n){var e=t.length;n||(n=new Int32Array(e));for(var i=0;e>i;++i)n[i]=Math.round(t[i]*r);return n}function U(t,r){var n,e;if(!r){var i=0;for(n=0,e=t.length;e>n;n+=2)i+=t[n+1];r=new t.constructor(i)}var o=0;for(n=0,e=t.length;e>n;n+=2)for(var u=t[n],a=t[n+1],s=0;a>s;++s)r[o]=u,o+=1;return r}function p(t){if(0===t.length)return new Int32Array;var r,n,e=2;for(r=1,n=t.length;n>r;++r)t[r-1]!==t[r]&&(e+=2);var i=new Int32Array(e),o=0,u=1;for(r=1,n=t.length;n>r;++r)t[r-1]!==t[r]?(i[o]=t[r-1],i[o+1]=u,u=1,o+=2):u+=1;return i[o]=t[t.length-1],i[o+1]=u,i}function b(t,r){var n=t.length;r||(r=new t.constructor(n)),n&&(r[0]=t[0]);for(var e=1;n>e;++e)r[e]=t[e]+r[e-1];return r}function I(t,r){var n=t.length;r||(r=new t.constructor(n)),r[0]=t[0];for(var e=1;n>e;++e)r[e]=t[e]-t[e-1];return r}function w(t,r){var n=t instanceof Int8Array?127:32767,e=-n-1,i=t.length;r||(r=new Int32Array(i));for(var o=0,u=0;i>o;){for(var a=0;(t[o]===n||t[o]===e)&&(a+=t[o],o+=1,0!==t[o]););a+=t[o],o+=1,r[u]=a,u+=1}return new r.constructor(r.buffer,r.byteOffset,u)}function C(t,r){var n,e=r?127:32767,i=-e-1,o=t.length,u=0;for(n=0;o>n;++n){var a=t[n];u+=0===a?1:a===e||a===i?2:a>0?Math.ceil(a/e):Math.ceil(a/i)}var s=r?new Int8Array(u):new Int16Array(u),f=0;for(n=0;o>n;++n){var a=t[n];if(a>=0)for(;a>=e;)s[f]=e,f+=1,a-=e;else for(;i>=a;)s[f]=i,f+=1,a-=i;s[f]=a,f+=1}return s}function A(t,r){return b(U(t),r)}function x(t){return p(I(t))}function F(t,r,n){return y(U(t,c(n)),r,n)}function S(t,r){return p(m(t,r))}function M(t,r,n){return y(b(t,c(n)),r,n)}function N(t,r,n){return I(m(t,r),n)}function O(t,r,n){return y(w(t,c(n)),r,n)}function E(t,r,n){var e=w(t,c(n));return M(e,r,d(e))}function T(t,r,n){return C(N(t,r),n)}function j(t){var r=a(t),n=r.getInt32(0),e=r.getInt32(4),i=t.subarray(8,12),t=t.subarray(12);return[n,t,e,i]}function k(t,r,n,e){var i=new ArrayBuffer(12+e.byteLength),o=new Uint8Array(i),u=new DataView(i);return u.setInt32(0,t),u.setInt32(4,r),n&&o.set(n,8),o.set(e,12),o}function q(t){var r=t.length,n=s(t);return k(2,r,void 0,n)}function D(t){var r=t.length,n=L(t);return k(4,r,void 0,n)}function P(t,r){var n=t.length/r,e=L([r]),i=s(t);return k(5,n,e,i)}function z(t){var r=t.length,n=L(p(t));return k(6,r,void 0,n)}function B(t){var r=t.length,n=L(x(t));return k(8,r,void 0,n)}function V(t,r){var n=t.length,e=L([r]),i=L(S(t,r));return k(9,n,e,i)}function G(t,r){var n=t.length,e=L([r]),i=g(T(t,r));return k(10,n,e,i)}function W(t){var r={};return Y.forEach(function(n){void 0!==t[n]&&(r[n]=t[n])}),t.bondAtomList&&(r.bondAtomList=D(t.bondAtomList)),t.bondOrderList&&(r.bondOrderList=q(t.bondOrderList)),r.xCoordList=G(t.xCoordList,1e3),r.yCoordList=G(t.yCoordList,1e3),r.zCoordList=G(t.zCoordList,1e3),t.bFactorList&&(r.bFactorList=G(t.bFactorList,100)),t.atomIdList&&(r.atomIdList=B(t.atomIdList)),t.altLocList&&(r.altLocList=z(t.altLocList)),t.occupancyList&&(r.occupancyList=V(t.occupancyList,100)),r.groupIdList=B(t.groupIdList),r.groupTypeList=D(t.groupTypeList),t.secStructList&&(r.secStructList=q(t.secStructList,1)),t.insCodeList&&(r.insCodeList=z(t.insCodeList)),t.sequenceIndexList&&(r.sequenceIndexList=B(t.sequenceIndexList)),r.chainIdList=P(t.chainIdList,4),t.chainNameList&&(r.chainNameList=P(t.chainNameList,4)),r}function H(t){function r(t){for(var r={},n=0;t>n;n++){var e=o();r[e]=o()}return r}function n(r){var n=t.subarray(u,u+r);return u+=r,n}function e(r){var n=t.subarray(u,u+r);u+=r;var e=65535;if(r>e){for(var i=[],o=0;o<n.length;o+=e)i.push(String.fromCharCode.apply(null,n.subarray(o,o+e)));return i.join("")}return String.fromCharCode.apply(null,n)}function i(t){for(var r=new Array(t),n=0;t>n;n++)r[n]=o();return r}function o(){var o,s,f=t[u];if(0===(128&f))return u++,f;if(128===(240&f))return s=15&f,u++,r(s);if(144===(240&f))return s=15&f,u++,i(s);if(160===(224&f))return s=31&f,u++,e(s);if(224===(224&f))return o=a.getInt8(u),u++,o;switch(f){case 192:return u++,null;case 194:return u++,!1;case 195:return u++,!0;case 196:return s=a.getUint8(u+1),u+=2,n(s);case 197:return s=a.getUint16(u+1),u+=3,n(s);case 198:return s=a.getUint32(u+1),u+=5,n(s);case 202:return o=a.getFloat32(u+1),u+=5,o;case 203:return o=a.getFloat64(u+1),u+=9,o;case 204:return o=t[u+1],u+=2,o;case 205:return o=a.getUint16(u+1),u+=3,o;case 206:return o=a.getUint32(u+1),u+=5,o;case 208:return o=a.getInt8(u+1),u+=2,o;case 209:return o=a.getInt16(u+1),u+=3,o;case 210:return o=a.getInt32(u+1),u+=5,o;case 217:return s=a.getUint8(u+1),u+=2,e(s);case 218:return s=a.getUint16(u+1),u+=3,e(s);case 219:return s=a.getUint32(u+1),u+=5,e(s);case 220:return s=a.getUint16(u+1),u+=3,i(s);case 221:return s=a.getUint32(u+1),u+=5,i(s);case 222:return s=a.getUint16(u+1),u+=3,r(s);case 223:return s=a.getUint32(u+1),u+=5,r(s)}throw new Error("Unknown type 0x"+f.toString(16))}var u=0,a=new DataView(t.buffer);return o()}function J(t,r){r=r||{};var n=r.ignoreFields,e={};return $.forEach(function(r){var i=n?-1!==n.indexOf(r):!1,o=t[r];if(!i&&void 0!==o)if(o instanceof Uint8Array){var u=j(o);e[r]=_[u[0]](u[1],u[2],u[3])}else e[r]=o}),e}function K(t){return String.fromCharCode.apply(null,t).replace(/\0/g,"")}function Q(t,r,n){n=n||{};var e,i,o,u,a,s,f=n.firstModelOnly,c=r.onModel,d=r.onChain,l=r.onGroup,g=r.onAtom,v=r.onBond,L=0,h=0,y=0,m=0,U=0,p=-1,b=t.chainNameList,I=t.secStructList,w=t.insCodeList,C=t.sequenceIndexList,A=t.atomIdList,x=t.bFactorList,F=t.altLocList,S=t.occupancyList,M=t.bondAtomList,N=t.bondOrderList;for(e=0,i=t.chainsPerModel.length;i>e&&!(f&&L>0);++e){var O=t.chainsPerModel[L];for(c&&c({chainCount:O,modelIndex:L}),o=0;O>o;++o){var E=t.groupsPerChain[h];if(d){var T=K(t.chainIdList.subarray(4*h,4*h+4)),j=null;b&&(j=K(b.subarray(4*h,4*h+4))),d({groupCount:E,chainIndex:h,modelIndex:L,chainId:T,chainName:j})}for(u=0;E>u;++u){var k=t.groupList[t.groupTypeList[y]],q=k.atomNameList.length;if(l){var D=null;I&&(D=I[y]);var P=null;t.insCodeList&&(P=String.fromCharCode(w[y]));var z=null;C&&(z=C[y]),l({atomCount:q,groupIndex:y,chainIndex:h,modelIndex:L,groupId:t.groupIdList[y],groupType:t.groupTypeList[y],groupName:k.groupName,singleLetterCode:k.singleLetterCode,chemCompType:k.chemCompType,secStruct:D,insCode:P,sequenceIndex:z})}for(a=0;q>a;++a){if(g){var B=null;A&&(B=A[m]);var V=null;x&&(V=x[m]);var G=null;F&&(G=String.fromCharCode(F[m]));var W=null;S&&(W=S[m]),g({atomIndex:m,groupIndex:y,chainIndex:h,modelIndex:L,atomId:B,element:k.elementList[a],atomName:k.atomNameList[a],formalCharge:k.formalChargeList[a],xCoord:t.xCoordList[m],yCoord:t.yCoordList[m],zCoord:t.zCoordList[m],bFactor:V,altLoc:G,occupancy:W})}m+=1}if(v){var H=k.bondAtomList;for(a=0,s=k.bondOrderList.length;s>a;++a)v({atomIndex1:m-q+H[2*a],atomIndex2:m-q+H[2*a+1],bondOrder:k.bondOrderList[a]})}y+=1}h+=1}if(U=p+1,p=m-1,v&&M)for(a=0,s=M.length;s>a;a+=2){var J=M[a],Q=M[a+1];(J>=U&&p>=J||Q>=U&&p>=Q)&&v({atomIndex1:J,atomIndex2:Q,bondOrder:N?N[a/2]:null})}L+=1}}function R(t){return o(W(t))}function X(t,r){t instanceof ArrayBuffer&&(t=new Uint8Array(t));var n;return n=t instanceof Uint8Array?H(t):t,J(n,r)}var Y=["mmtfVersion","mmtfProducer","unitCell","spaceGroup","structureId","title","depositionDate","releaseDate","experimentalMethods","resolution","rFree","rWork","bioAssemblyList","entityList","groupList","numBonds","numAtoms","numGroups","numChains","numModels","groupsPerChain","chainsPerModel"],Z=["xCoordList","yCoordList","zCoordList","groupIdList","groupTypeList","chainIdList","bFactorList","atomIdList","altLocList","occupancyList","secStructList","insCodeList","sequenceIndexList","chainNameList","bondAtomList","bondOrderList"],$=Y.concat(Z),_={1:function(t,r){return h(t)},2:function(t,r){return f(t)},3:function(t,r){return l(t)},4:function(t,r){return v(t)},5:function(t,r,n){return s(t)},6:function(t,r){return U(v(t),new Uint8Array(r))},7:function(t,r){return U(v(t))},8:function(t,r){return A(v(t))},9:function(t,r,n){return F(v(t),v(n)[0])},10:function(t,r,n){return E(l(t),v(n)[0])},11:function(t,r,n){return y(l(t),v(n)[0])},12:function(t,r,n){return O(l(t),v(n)[0])},13:function(t,r,n){return O(f(t),v(n)[0])}},tt="v0.2.3";t.encode=R,t.decode=X,t.traverse=Q,t.version=tt});