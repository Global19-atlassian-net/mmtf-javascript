!function(r,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(r.MMTF=r.MMTF||{})}(this,function(r){"use strict";function t(r,t,e){for(var n=(r.byteLength,0),i=e.length;i>n;n++){var o=e.charCodeAt(n);if(128>o)r.setUint8(t++,o>>>0&127|0);else if(2048>o)r.setUint8(t++,o>>>6&31|192),r.setUint8(t++,o>>>0&63|128);else if(65536>o)r.setUint8(t++,o>>>12&15|224),r.setUint8(t++,o>>>6&63|128),r.setUint8(t++,o>>>0&63|128);else{if(!(1114112>o))throw new Error("bad codepoint "+o);r.setUint8(t++,o>>>18&7|240),r.setUint8(t++,o>>>12&63|128),r.setUint8(t++,o>>>6&63|128),r.setUint8(t++,o>>>0&63|128)}}}function e(r){for(var t=0,e=0,n=r.length;n>e;e++){var i=r.charCodeAt(e);if(128>i)t+=1;else if(2048>i)t+=2;else if(65536>i)t+=3;else{if(!(1114112>i))throw new Error("bad codepoint "+i);t+=4}}return t}function n(r,i,o){var a=typeof r;if("string"===a){var u=e(r);if(32>u)return i.setUint8(o,160|u),t(i,o+1,r),1+u;if(256>u)return i.setUint8(o,217),i.setUint8(o+1,u),t(i,o+2,r),2+u;if(65536>u)return i.setUint8(o,218),i.setUint16(o+1,u),t(i,o+3,r),3+u;if(4294967296>u)return i.setUint8(o,219),i.setUint32(o+1,u),t(i,o+5,r),5+u}if(r instanceof ArrayBuffer){var u=r.byteLength;if(256>u)return i.setUint8(o,196),i.setUint8(o+1,u),new Uint8Array(i.buffer).set(new Uint8Array(r),o+2),2+u;if(65536>u)return i.setUint8(o,197),i.setUint16(o+1,u),new Uint8Array(i.buffer).set(new Uint8Array(r),o+3),3+u;if(4294967296>u)return i.setUint8(o,198),i.setUint32(o+1,u),new Uint8Array(i.buffer).set(new Uint8Array(r),o+5),5+u}if("number"===a){if(!isFinite(r))throw new Error("Number not finite: "+r);if(Math.floor(r)!==r)return i.setUint8(o,203),i.setFloat64(o+1,r),9;if(r>=0){if(128>r)return i.setUint8(o,r),1;if(256>r)return i.setUint8(o,204),i.setUint8(o+1,r),2;if(65536>r)return i.setUint8(o,205),i.setUint16(o+1,r),3;if(4294967296>r)return i.setUint8(o,206),i.setUint32(o+1,r),5;throw new Error("Number too big 0x"+r.toString(16))}if(r>=-32)return i.setInt8(o,r),1;if(r>=-128)return i.setUint8(o,208),i.setInt8(o+1,r),2;if(r>=-32768)return i.setUint8(o,209),i.setInt16(o+1,r),3;if(r>=-2147483648)return i.setUint8(o,210),i.setInt32(o+1,r),5;throw new Error("Number too small -0x"+(-r).toString(16).substr(1))}if(null===r)return i.setUint8(o,192),1;if("boolean"===a)return i.setUint8(o,r?195:194),1;if("object"===a){var u,f=0,s=Array.isArray(r);if(s)u=r.length;else{var c=Object.keys(r);u=c.length}var f;if(16>u?(i.setUint8(o,u|(s?144:128)),f=1):65536>u?(i.setUint8(o,s?220:222),i.setUint16(o+1,u),f=3):4294967296>u&&(i.setUint8(o,s?221:223),i.setUint32(o+1,u),f=5),s)for(var d=0;u>d;d++)f+=n(r[d],i,o+f);else for(var d=0;u>d;d++){var y=c[d];f+=n(y,i,o+f),f+=n(r[y],i,o+f)}return f}throw new Error("Unknown type "+a)}function i(r){var t=typeof r;if("string"===t){var n=e(r);if(32>n)return 1+n;if(256>n)return 2+n;if(65536>n)return 3+n;if(4294967296>n)return 5+n}if(r instanceof ArrayBuffer){var n=r.byteLength;if(256>n)return 2+n;if(65536>n)return 3+n;if(4294967296>n)return 5+n}if("number"===t){if(Math.floor(r)!==r)return 9;if(r>=0){if(128>r)return 1;if(256>r)return 2;if(65536>r)return 3;if(4294967296>r)return 5;throw new Error("Number too big 0x"+r.toString(16))}if(r>=-32)return 1;if(r>=-128)return 2;if(r>=-32768)return 3;if(r>=-2147483648)return 5;throw new Error("Number too small -0x"+r.toString(16).substr(1))}if("boolean"===t||null===r)return 1;if("object"===t){var n,o=0;if(Array.isArray(r)){n=r.length;for(var a=0;n>a;a++)o+=i(r[a])}else{var u=Object.keys(r);n=u.length;for(var a=0;n>a;a++){var f=u[a];o+=i(f)+i(r[f])}}if(16>n)return 1+o;if(65536>n)return 3+o;if(4294967296>n)return 5+o;throw new Error("Array or object too long 0x"+n.toString(16))}throw new Error("Unknown type "+t)}function o(r){var t=new ArrayBuffer(i(r)),e=new DataView(t);return n(r,e,0),new Uint8Array(t)}function a(r){return new Uint8Array(r.buffer,r.byteOffset,r.byteLength)}function u(r){return new Int8Array(r.buffer,r.byteOffset,r.byteLength)}function f(r,t){var e,n,i,o=(r.byteOffset,r.byteLength);for(t||(t=new Int16Array(o/2)),e=0,n=0,i=o/2;i>e;++e,n+=2)t[e]=r[n]<<8^r[n+1]<<0;return t}function s(r,t){var e=r.length;t||(t=new Uint8Array(2*e));for(var n=new DataView(t.buffer,t.byteOffset,t.byteLength),i=0;e>i;++i)n.setInt16(2*i,r[i]);return t.buffer}function c(r,t){var e,n,i,o=(r.byteOffset,r.byteLength);for(t||(t=new Int32Array(o/4)),e=0,n=0,i=o/4;i>e;++e,n+=4)t[e]=r[n]<<24^r[n+1]<<16^r[n+2]<<8^r[n+3]<<0;return t}function d(r){return new Int32Array(r.buffer,r.byteOffset,r.byteLength/4)}function y(r,t){var e=r.length;t||(t=new Uint8Array(4*e));for(var n=new DataView(t.buffer,t.byteOffset,t.byteLength),i=0;e>i;++i)n.setInt32(4*i,r[i]);return t.buffer}function l(r,t){var e,n,i,o=(r.byteOffset,r.byteLength);t||(t=new Float32Array(o/4));var a=new DataView(t.buffer,t.byteOffset,t.byteLength),u=new DataView(r.buffer,r.byteOffset,r.byteLength);for(e=0,n=0,i=o/4;i>e;++e,n+=4)a.setFloat32(n,u.getFloat32(n),!0);return t}function g(r,t,e){var n=r.length,i=1/t;e||(e=new Float32Array(n));for(var o=0;n>o;++o)e[o]=r[o]*i;return e}function L(r,t,e,n){e||(e=4);var i=r.length,o=new ArrayBuffer(i*e),a=new DataView(o),u="setInt32";1===e?u="setInt8":2===e&&(u="setInt16");for(var f=0;i>f;++f)a[u](e*f,Math.round(r[f]*t),n);return o}function v(r,t){var e,n;if(!t){var i=0;for(e=0,n=r.length;n>e;e+=2)i+=r[e+1];t=new r.constructor(i)}var o=0;for(e=0,n=r.length;n>e;e+=2)for(var a=r[e],u=r[e+1],f=0;u>f;++f)t[o]=a,o+=1;return t}function w(r){if(0===r.length)return new ArrayBuffer;var t,e,n=2;for(t=1,e=r.length;e>t;++t)r[t-1]!==r[t]&&(n+=2);var i=new ArrayBuffer(4*n),o=new DataView(i),a=0,u=1;for(t=1,e=r.length;e>t;++t)r[t-1]!==r[t]?(o.setInt32(a,r[t-1]),o.setInt32(a+4,u),u=1,a+=8):u+=1;return o.setInt32(a,r[r.length-1]),o.setInt32(a+4,u),i}function b(r){for(var t=1,e=r.length;e>t;++t)r[t]+=r[t-1];return r}function h(r,t){t||(t=new r.constructor(r.length)),t[0]=r[0];for(var e=1,n=t.length;n>e;++e)t[e]=r[e]-r[e-1];return t}function U(r,t){if(0===r.length)return[new ArrayBuffer,new ArrayBuffer];var e,n,i=t?127:32767,o=t?Int8Array:Int16Array,a=h(r),u=2,f=0;for(e=1,n=a.length;n>e;++e){var c=a[e];c>i||-i>c?u+=2:f+=1}var d=new Int32Array(u),l=new o(f),g=0,L=0;for(d[g]=a[0],d[g+1]=0,g+=2,e=1,n=a.length;n>e;++e){var c=a[e];c>i||-i>c?(d[g]=c,d[g+1]=0,g+=2):(l[L]=c,L+=1,d[g-1]+=1)}return[y(d,d),t?l:s(l,l)]}function m(r,t,e){var n=new Int32Array(L(r,t,4,!0));return U(n,e)}function A(r,t,e){var n=e?d(e):void 0,i=v(c(r),n);return g(i,t,e)}function I(r,t){var e=32767,n=-32768,i=r.length;t||(t=new Int32Array(i));for(var o=0,a=0;i>o;){for(var u=0;(r[o]===e||r[o]===n)&&(u+=r[o],o+=1,0!==r[o]););u+=r[o],o+=1,t[a]=u,a+=1}return new Int32Array(t.buffer,0,a)}function p(r,t,e){var n=b(I(r,e));return g(n,t,e)}function C(r){var t={};E.forEach(function(e){void 0!==r[e]&&(t[e]=r[e])}),r.bondAtomList&&(t.bondAtomList=new Uint8Array(y(r.bondAtomList))),r.bondOrderList&&(t.bondOrderList=new Uint8Array(r.bondOrderList.buffer));var e=m(r.xCoordList,1e3);t.xCoordBig=new Uint8Array(e[0]),t.xCoordSmall=new Uint8Array(e[1]);var n=m(r.yCoordList,1e3);t.yCoordBig=new Uint8Array(n[0]),t.yCoordSmall=new Uint8Array(n[1]);var i=m(r.zCoordList,1e3);if(t.zCoordBig=new Uint8Array(i[0]),t.zCoordSmall=new Uint8Array(i[1]),r.bFactorList){var o=m(r.bFactorList,100);t.bFactorBig=new Uint8Array(o[0]),t.bFactorSmall=new Uint8Array(o[1])}return r.atomIdList&&(t.atomIdList=new Uint8Array(w(h(r.atomIdList)))),r.altLocList&&(t.altLocList=new Uint8Array(w(r.altLocList))),r.occupancyList&&(t.occupancyList=new Uint8Array(w(new Int32Array(L(r.occupancyList,100,4,!0))))),t.groupIdList=new Uint8Array(w(h(r.groupIdList))),t.groupTypeList=new Uint8Array(y(r.groupTypeList)),r.secStructList&&(t.secStructList=new Uint8Array(r.secStructList.buffer)),r.insCodeList&&(t.insCodeList=new Uint8Array(w(r.insCodeList))),r.sequenceIndexList&&(t.sequenceIndexList=new Uint8Array(w(h(r.sequenceIndexList)))),t.chainIdList=new Uint8Array(r.chainIdList.buffer),r.chainNameList&&(t.chainNameList=new Uint8Array(r.chainNameList.buffer)),t}function x(r){function t(r){for(var t={},e=0;r>e;e++){var n=o();t[n]=o()}return t}function e(t){var e=r.subarray(a,a+t);return a+=t,e}function n(t){var e=r.subarray(a,a+t);a+=t;var n=65535;if(t>n){for(var i=[],o=0;o<e.length;o+=n)i.push(String.fromCharCode.apply(null,e.subarray(o,o+n)));return i.join("")}return String.fromCharCode.apply(null,e)}function i(r){for(var t=new Array(r),e=0;r>e;e++)t[e]=o();return t}function o(){var o,f,s=r[a];if(0===(128&s))return a++,s;if(128===(240&s))return f=15&s,a++,t(f);if(144===(240&s))return f=15&s,a++,i(f);if(160===(224&s))return f=31&s,a++,n(f);if(224===(224&s))return o=u.getInt8(a),a++,o;switch(s){case 192:return a++,null;case 194:return a++,!1;case 195:return a++,!0;case 196:return f=u.getUint8(a+1),a+=2,e(f);case 197:return f=u.getUint16(a+1),a+=3,e(f);case 198:return f=u.getUint32(a+1),a+=5,e(f);case 202:return o=u.getFloat32(a+1),a+=5,o;case 203:return o=u.getFloat64(a+1),a+=9,o;case 204:return o=r[a+1],a+=2,o;case 205:return o=u.getUint16(a+1),a+=3,o;case 206:return o=u.getUint32(a+1),a+=5,o;case 208:return o=u.getInt8(a+1),a+=2,o;case 209:return o=u.getInt16(a+1),a+=3,o;case 210:return o=u.getInt32(a+1),a+=5,o;case 217:return f=u.getUint8(a+1),a+=2,n(f);case 218:return f=u.getUint16(a+1),a+=3,n(f);case 219:return f=u.getUint32(a+1),a+=5,n(f);case 220:return f=u.getUint16(a+1),a+=3,i(f);case 221:return f=u.getUint32(a+1),a+=5,i(f);case 222:return f=u.getUint16(a+1),a+=3,t(f);case 223:return f=u.getUint32(a+1),a+=5,t(f)}throw new Error("Unknown type 0x"+s.toString(16))}var a=0,u=new DataView(r.buffer);return o()}function O(r){if(r instanceof Uint8Array){var t=new DataView(r.buffer,r.byteOffset,r.byteLength),e=t.getInt32(0),n=t.getInt32(4),i=r.subarray(8,12),o=r.subarray(12);return D[e](o,n,i)}return r}function S(r,t){t=t||{};var e=t.ignoreFields,n={};return E.forEach(function(t){var i=e?-1!==e.indexOf(t):!1;i||void 0===r[t]||(n[t]=O(r[t]))}),n}function F(r){return String.fromCharCode.apply(null,r).replace(/\0/g,"")}function N(r,t,e){e=e||{};var n,i,o,a,u,f,s=e.firstModelOnly,c=t.onModel,d=t.onChain,y=t.onGroup,l=t.onAtom,g=t.onBond,L=0,v=0,w=0,b=0,h=0,U=-1,m=r.chainNameList,A=r.secStructList,I=r.insCodeList,p=r.sequenceIndexList,C=r.atomIdList,x=r.bFactorList,O=r.altLocList,S=r.occupancyList,N=r.bondAtomList,B=r.bondOrderList;for(n=0,i=r.chainsPerModel.length;i>n&&!(s&&L>0);++n){var M=r.chainsPerModel[L];for(c&&c({chainCount:M,modelIndex:L}),o=0;M>o;++o){var E=r.groupsPerChain[v];if(d){var D=F(r.chainIdList.subarray(4*v,4*v+4)),T=null;m&&(T=F(m.subarray(4*v,4*v+4))),d({groupCount:E,chainIndex:v,modelIndex:L,chainId:D,chainName:T})}for(a=0;E>a;++a){var V=r.groupList[r.groupTypeList[w]],j=V.atomNameList.length;if(y){var k=null;A&&(k=A[w]);var q=null;r.insCodeList&&(q=String.fromCharCode(I[w]));var z=null;p&&(z=p[w]),y({atomCount:j,groupIndex:w,chainIndex:v,modelIndex:L,groupId:r.groupIdList[w],groupType:r.groupTypeList[w],groupName:V.groupName,singleLetterCode:V.singleLetterCode,chemCompType:V.chemCompType,secStruct:k,insCode:q,sequenceIndex:z})}for(u=0;j>u;++u){if(l){var P=null;C&&(P=C[b]);var G=null;x&&(G=x[b]);var R=null;O&&(R=String.fromCharCode(O[b]));var W=null;S&&(W=S[b]),l({atomIndex:b,groupIndex:w,chainIndex:v,modelIndex:L,atomId:P,element:V.elementList[u],atomName:V.atomNameList[u],atomCharge:V.atomChargeList[u],xCoord:r.xCoordList[b],yCoord:r.yCoordList[b],zCoord:r.zCoordList[b],bFactor:G,altLoc:R,occupancy:W})}b+=1}if(g){var H=V.bondAtomList;for(u=0,f=V.bondOrderList.length;f>u;++u)g({atomIndex1:b-j+H[2*u],atomIndex2:b-j+H[2*u+1],bondOrder:V.bondOrderList[u]})}w+=1}v+=1}if(h=U+1,U=b-1,g&&N)for(u=0,f=N.length;f>u;u+=2){var J=N[u],K=N[u+1];(J>=h&&U>=J||K>=h&&U>=K)&&g({atomIndex1:J,atomIndex2:K,bondOrder:B?B[u/2]:null})}L+=1}}function B(r){return o(C(r))}function M(r,t){r instanceof ArrayBuffer&&(r=new Uint8Array(r));var e;return e=r instanceof Uint8Array?x(r):r,S(e,t)}var E=["mmtfVersion","mmtfProducer","unitCell","spaceGroup","structureId","title","depositionDate","releaseDate","experimentalMethods","resolution","rFree","rWork","bioAssemblyList","entityList","groupList","numBonds","numAtoms","numGroups","numChains","numModels","groupsPerChain","chainsPerModel","xCoordList","yCoordList","zCoordList","groupIdList","groupTypeList","chainIdList","bFactorList","atomIdList","altLocList","occupancyList","secStructList","insCodeList","sequenceIndexList","chainNameList","bondAtomList","bondOrderList"],D={1:function(r,t){return l(r)},2:function(r,t){return u(r)},3:function(r,t){return f(r)},4:function(r,t){return c(r)},5:function(r,t,e){c(e)[0];return a(r)},6:function(r,t){var e=new Uint8Array(t);return v(c(r),e)},7:function(r,t){return v(c(r))},8:function(r,t){return b(v(c(r)))},9:function(r,t,e){var n=c(e)[0];return A(r,n)},10:function(r,t,e){var n=c(e)[0];return p(f(r),n)},11:function(r,t,e){var n=c(e)[0];return decodeIntegerToFloat(f(r),n)},12:function(r,t,e){var n=c(e)[0];return decodeIntegerRecursiveIndexing(f(r),n)},13:function(r,t,e){var n=c(e)[0];return decodeIntegerRecursiveIndexing(getInt8(r),n)}},T="v0.2.3";r.encode=B,r.decode=M,r.traverse=N,r.version=T});