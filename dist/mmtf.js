!function(r,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(r.MMTF=r.MMTF||{})}(this,function(r){"use strict";function t(r,t,n){for(var e=(r.byteLength,0),i=n.length;i>e;e++){var o=n.charCodeAt(e);if(128>o)r.setUint8(t++,o>>>0&127|0);else if(2048>o)r.setUint8(t++,o>>>6&31|192),r.setUint8(t++,o>>>0&63|128);else if(65536>o)r.setUint8(t++,o>>>12&15|224),r.setUint8(t++,o>>>6&63|128),r.setUint8(t++,o>>>0&63|128);else{if(!(1114112>o))throw new Error("bad codepoint "+o);r.setUint8(t++,o>>>18&7|240),r.setUint8(t++,o>>>12&63|128),r.setUint8(t++,o>>>6&63|128),r.setUint8(t++,o>>>0&63|128)}}}function n(r){for(var t=0,n=0,e=r.length;e>n;n++){var i=r.charCodeAt(n);if(128>i)t+=1;else if(2048>i)t+=2;else if(65536>i)t+=3;else{if(!(1114112>i))throw new Error("bad codepoint "+i);t+=4}}return t}function e(r,i,o){var a=typeof r;if("string"===a){var u=n(r);if(32>u)return i.setUint8(o,160|u),t(i,o+1,r),1+u;if(256>u)return i.setUint8(o,217),i.setUint8(o+1,u),t(i,o+2,r),2+u;if(65536>u)return i.setUint8(o,218),i.setUint16(o+1,u),t(i,o+3,r),3+u;if(4294967296>u)return i.setUint8(o,219),i.setUint32(o+1,u),t(i,o+5,r),5+u}if(r instanceof ArrayBuffer){var u=r.byteLength;if(256>u)return i.setUint8(o,196),i.setUint8(o+1,u),new Uint8Array(i.buffer).set(new Uint8Array(r),o+2),2+u;if(65536>u)return i.setUint8(o,197),i.setUint16(o+1,u),new Uint8Array(i.buffer).set(new Uint8Array(r),o+3),3+u;if(4294967296>u)return i.setUint8(o,198),i.setUint32(o+1,u),new Uint8Array(i.buffer).set(new Uint8Array(r),o+5),5+u}if("number"===a){if(!isFinite(r))throw new Error("Number not finite: "+r);if(Math.floor(r)!==r)return i.setUint8(o,203),i.setFloat64(o+1,r),9;if(r>=0){if(128>r)return i.setUint8(o,r),1;if(256>r)return i.setUint8(o,204),i.setUint8(o+1,r),2;if(65536>r)return i.setUint8(o,205),i.setUint16(o+1,r),3;if(4294967296>r)return i.setUint8(o,206),i.setUint32(o+1,r),5;throw new Error("Number too big 0x"+r.toString(16))}if(r>=-32)return i.setInt8(o,r),1;if(r>=-128)return i.setUint8(o,208),i.setInt8(o+1,r),2;if(r>=-32768)return i.setUint8(o,209),i.setInt16(o+1,r),3;if(r>=-2147483648)return i.setUint8(o,210),i.setInt32(o+1,r),5;throw new Error("Number too small -0x"+(-r).toString(16).substr(1))}if(null===r)return i.setUint8(o,192),1;if("boolean"===a)return i.setUint8(o,r?195:194),1;if("object"===a){var u,s=0,f=Array.isArray(r);if(f)u=r.length;else{var c=Object.keys(r);u=c.length}var s;if(16>u?(i.setUint8(o,u|(f?144:128)),s=1):65536>u?(i.setUint8(o,f?220:222),i.setUint16(o+1,u),s=3):4294967296>u&&(i.setUint8(o,f?221:223),i.setUint32(o+1,u),s=5),f)for(var d=0;u>d;d++)s+=e(r[d],i,o+s);else for(var d=0;u>d;d++){var l=c[d];s+=e(l,i,o+s),s+=e(r[l],i,o+s)}return s}throw new Error("Unknown type "+a)}function i(r){var t=typeof r;if("string"===t){var e=n(r);if(32>e)return 1+e;if(256>e)return 2+e;if(65536>e)return 3+e;if(4294967296>e)return 5+e}if(r instanceof ArrayBuffer){var e=r.byteLength;if(256>e)return 2+e;if(65536>e)return 3+e;if(4294967296>e)return 5+e}if("number"===t){if(Math.floor(r)!==r)return 9;if(r>=0){if(128>r)return 1;if(256>r)return 2;if(65536>r)return 3;if(4294967296>r)return 5;throw new Error("Number too big 0x"+r.toString(16))}if(r>=-32)return 1;if(r>=-128)return 2;if(r>=-32768)return 3;if(r>=-2147483648)return 5;throw new Error("Number too small -0x"+r.toString(16).substr(1))}if("boolean"===t||null===r)return 1;if("object"===t){var e,o=0;if(Array.isArray(r)){e=r.length;for(var a=0;e>a;a++)o+=i(r[a])}else{var u=Object.keys(r);e=u.length;for(var a=0;e>a;a++){var s=u[a];o+=i(s)+i(r[s])}}if(16>e)return 1+o;if(65536>e)return 3+o;if(4294967296>e)return 5+o;throw new Error("Array or object too long 0x"+e.toString(16))}throw new Error("Unknown type "+t)}function o(r){var t=new ArrayBuffer(i(r)),n=new DataView(t);return e(r,n,0),new Uint8Array(t)}function a(r,t,n){return t?new r(t.buffer,t.byteOffset,t.byteLength/(n||1)):void 0}function u(r){return a(DataView,r)}function s(r){return a(Uint8Array,r)}function f(r){return a(Int8Array,r)}function c(r){return a(Int32Array,r,4)}function d(r){return a(Float32Array,r,4)}function l(r,t){var n=r.length/2;t||(t=new Int16Array(n));for(var e=0,i=0;n>e;++e,i+=2)t[e]=r[i]<<8^r[i+1]<<0;return t}function L(r,t){var n=r.length/4;t||(t=new Int32Array(n));for(var e=0,i=0;n>e;++e,i+=4)t[e]=r[i]<<24^r[i+1]<<16^r[i+2]<<8^r[i+3]<<0;return t}function y(r,t){var n=r.length;t||(t=new Float32Array(n/4));for(var e=u(t),i=u(r),o=0,a=0,s=n/4;s>o;++o,a+=4)e.setFloat32(a,i.getFloat32(a),!0);return t}function g(r,t,n){var e=r.length,i=1/t;n||(n=new Float32Array(e));for(var o=0;e>o;++o)n[o]=r[o]*i;return n}function U(r,t){var n,e;if(!t){var i=0;for(n=0,e=r.length;e>n;n+=2)i+=r[n+1];t=new r.constructor(i)}var o=0;for(n=0,e=r.length;e>n;n+=2)for(var a=r[n],u=r[n+1],s=0;u>s;++s)t[o]=a,o+=1;return t}function h(r,t){var n=r.length;t||(t=new r.constructor(n)),n&&(t[0]=r[0]);for(var e=1;n>e;++e)t[e]=r[e]+t[e-1];return t}function v(r,t){var n=r.length;t||(t=new r.constructor(n)),t[0]=r[0];for(var e=1;n>e;++e)t[e]=r[e]-r[e-1];return t}function m(r,t){var n=r instanceof Int8Array?127:32767,e=-n-1,i=r.length;t||(t=new Int32Array(i));for(var o=0,a=0;i>o;){for(var u=0;(r[o]===n||r[o]===e)&&(u+=r[o],o+=1,0!==r[o]););u+=r[o],o+=1,t[a]=u,a+=1}return new t.constructor(t.buffer,t.byteOffset,a)}function w(r,t){return h(U(r),t)}function b(r,t,n){return g(U(r,c(n)),t,n)}function p(r,t,n){return g(h(r,c(n)),t,n)}function A(r,t,n){return g(m(r,c(n)),t,n)}function I(r,t,n){var e=m(r,c(n));return p(e,t,d(e))}function C(r){var t=u(r),n=t.getInt32(0),e=t.getInt32(4),i=r.subarray(8,12),r=r.subarray(12);return[n,r,e,i]}function x(r){var t={};B.forEach(function(n){void 0!==r[n]&&(t[n]=r[n])}),r.bondAtomList&&(t.bondAtomList=new Uint8Array(makeInt32Buffer(r.bondAtomList))),r.bondOrderList&&(t.bondOrderList=new Uint8Array(r.bondOrderList.buffer));var n=encodeFloatSplitListDelta(r.xCoordList,1e3);t.xCoordBig=new Uint8Array(n[0]),t.xCoordSmall=new Uint8Array(n[1]);var e=encodeFloatSplitListDelta(r.yCoordList,1e3);t.yCoordBig=new Uint8Array(e[0]),t.yCoordSmall=new Uint8Array(e[1]);var i=encodeFloatSplitListDelta(r.zCoordList,1e3);if(t.zCoordBig=new Uint8Array(i[0]),t.zCoordSmall=new Uint8Array(i[1]),r.bFactorList){var o=encodeFloatSplitListDelta(r.bFactorList,100);t.bFactorBig=new Uint8Array(o[0]),t.bFactorSmall=new Uint8Array(o[1])}return r.atomIdList&&(t.atomIdList=new Uint8Array(encodeRunLength(v(r.atomIdList)))),r.altLocList&&(t.altLocList=new Uint8Array(encodeRunLength(r.altLocList))),r.occupancyList&&(t.occupancyList=new Uint8Array(encodeRunLength(new Int32Array(encodeFloatToInteger(r.occupancyList,100,4,!0))))),t.groupIdList=new Uint8Array(encodeRunLength(v(r.groupIdList))),t.groupTypeList=new Uint8Array(makeInt32Buffer(r.groupTypeList)),r.secStructList&&(t.secStructList=new Uint8Array(r.secStructList.buffer)),r.insCodeList&&(t.insCodeList=new Uint8Array(encodeRunLength(r.insCodeList))),r.sequenceIndexList&&(t.sequenceIndexList=new Uint8Array(encodeRunLength(v(r.sequenceIndexList)))),t.chainIdList=new Uint8Array(r.chainIdList.buffer),r.chainNameList&&(t.chainNameList=new Uint8Array(r.chainNameList.buffer)),t}function F(r){function t(r){for(var t={},n=0;r>n;n++){var e=o();t[e]=o()}return t}function n(t){var n=r.subarray(a,a+t);return a+=t,n}function e(t){var n=r.subarray(a,a+t);a+=t;var e=65535;if(t>e){for(var i=[],o=0;o<n.length;o+=e)i.push(String.fromCharCode.apply(null,n.subarray(o,o+e)));return i.join("")}return String.fromCharCode.apply(null,n)}function i(r){for(var t=new Array(r),n=0;r>n;n++)t[n]=o();return t}function o(){var o,s,f=r[a];if(0===(128&f))return a++,f;if(128===(240&f))return s=15&f,a++,t(s);if(144===(240&f))return s=15&f,a++,i(s);if(160===(224&f))return s=31&f,a++,e(s);if(224===(224&f))return o=u.getInt8(a),a++,o;switch(f){case 192:return a++,null;case 194:return a++,!1;case 195:return a++,!0;case 196:return s=u.getUint8(a+1),a+=2,n(s);case 197:return s=u.getUint16(a+1),a+=3,n(s);case 198:return s=u.getUint32(a+1),a+=5,n(s);case 202:return o=u.getFloat32(a+1),a+=5,o;case 203:return o=u.getFloat64(a+1),a+=9,o;case 204:return o=r[a+1],a+=2,o;case 205:return o=u.getUint16(a+1),a+=3,o;case 206:return o=u.getUint32(a+1),a+=5,o;case 208:return o=u.getInt8(a+1),a+=2,o;case 209:return o=u.getInt16(a+1),a+=3,o;case 210:return o=u.getInt32(a+1),a+=5,o;case 217:return s=u.getUint8(a+1),a+=2,e(s);case 218:return s=u.getUint16(a+1),a+=3,e(s);case 219:return s=u.getUint32(a+1),a+=5,e(s);case 220:return s=u.getUint16(a+1),a+=3,i(s);case 221:return s=u.getUint32(a+1),a+=5,i(s);case 222:return s=u.getUint16(a+1),a+=3,t(s);case 223:return s=u.getUint32(a+1),a+=5,t(s)}throw new Error("Unknown type 0x"+f.toString(16))}var a=0,u=new DataView(r.buffer);return o()}function S(r,t){t=t||{};var n=t.ignoreFields,e={};return B.forEach(function(t){var i=n?-1!==n.indexOf(t):!1,o=r[t];if(!i&&void 0!==o)if(o instanceof Uint8Array){var a=C(o);e[t]=T[a[0]](a[1],a[2],a[3])}else e[t]=o}),e}function N(r){return String.fromCharCode.apply(null,r).replace(/\0/g,"")}function O(r,t,n){n=n||{};var e,i,o,a,u,s,f=n.firstModelOnly,c=t.onModel,d=t.onChain,l=t.onGroup,L=t.onAtom,y=t.onBond,g=0,U=0,h=0,v=0,m=0,w=-1,b=r.chainNameList,p=r.secStructList,A=r.insCodeList,I=r.sequenceIndexList,C=r.atomIdList,x=r.bFactorList,F=r.altLocList,S=r.occupancyList,O=r.bondAtomList,E=r.bondOrderList;for(e=0,i=r.chainsPerModel.length;i>e&&!(f&&g>0);++e){var M=r.chainsPerModel[g];for(c&&c({chainCount:M,modelIndex:g}),o=0;M>o;++o){var B=r.groupsPerChain[U];if(d){var T=N(r.chainIdList.subarray(4*U,4*U+4)),D=null;b&&(D=N(b.subarray(4*U,4*U+4))),d({groupCount:B,chainIndex:U,modelIndex:g,chainId:T,chainName:D})}for(a=0;B>a;++a){var k=r.groupList[r.groupTypeList[h]],j=k.atomNameList.length;if(l){var q=null;p&&(q=p[h]);var z=null;r.insCodeList&&(z=String.fromCharCode(A[h]));var P=null;I&&(P=I[h]),l({atomCount:j,groupIndex:h,chainIndex:U,modelIndex:g,groupId:r.groupIdList[h],groupType:r.groupTypeList[h],groupName:k.groupName,singleLetterCode:k.singleLetterCode,chemCompType:k.chemCompType,secStruct:q,insCode:z,sequenceIndex:P})}for(u=0;j>u;++u){if(L){var R=null;C&&(R=C[v]);var V=null;x&&(V=x[v]);var G=null;F&&(G=String.fromCharCode(F[v]));var W=null;S&&(W=S[v]),L({atomIndex:v,groupIndex:h,chainIndex:U,modelIndex:g,atomId:R,element:k.elementList[u],atomName:k.atomNameList[u],atomCharge:k.atomChargeList[u],xCoord:r.xCoordList[v],yCoord:r.yCoordList[v],zCoord:r.zCoordList[v],bFactor:V,altLoc:G,occupancy:W})}v+=1}if(y){var H=k.bondAtomList;for(u=0,s=k.bondOrderList.length;s>u;++u)y({atomIndex1:v-j+H[2*u],atomIndex2:v-j+H[2*u+1],bondOrder:k.bondOrderList[u]})}h+=1}U+=1}if(m=w+1,w=v-1,y&&O)for(u=0,s=O.length;s>u;u+=2){var J=O[u],K=O[u+1];(J>=m&&w>=J||K>=m&&w>=K)&&y({atomIndex1:J,atomIndex2:K,bondOrder:E?E[u/2]:null})}g+=1}}function E(r){return o(x(r))}function M(r,t){r instanceof ArrayBuffer&&(r=new Uint8Array(r));var n;return n=r instanceof Uint8Array?F(r):r,S(n,t)}var B=["mmtfVersion","mmtfProducer","unitCell","spaceGroup","structureId","title","depositionDate","releaseDate","experimentalMethods","resolution","rFree","rWork","bioAssemblyList","entityList","groupList","numBonds","numAtoms","numGroups","numChains","numModels","groupsPerChain","chainsPerModel","xCoordList","yCoordList","zCoordList","groupIdList","groupTypeList","chainIdList","bFactorList","atomIdList","altLocList","occupancyList","secStructList","insCodeList","sequenceIndexList","chainNameList","bondAtomList","bondOrderList"],T={1:function(r,t){return y(r)},2:function(r,t){return f(r)},3:function(r,t){return l(r)},4:function(r,t){return L(r)},5:function(r,t,n){return s(r)},6:function(r,t){return U(L(r),new Uint8Array(t))},7:function(r,t){return U(L(r))},8:function(r,t){return w(L(r))},9:function(r,t,n){return b(L(r),L(n)[0])},10:function(r,t,n){return I(l(r),L(n)[0])},11:function(r,t,n){return g(l(r),L(n)[0])},12:function(r,t,n){return A(l(r),L(n)[0])},13:function(r,t,n){return A(f(r),L(n)[0])}},D="v0.2.3";r.encode=E,r.decode=M,r.traverse=O,r.version=D});