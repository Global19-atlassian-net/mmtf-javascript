!function(r,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(r.MMTF=r.MMTF||{})}(this,function(r){"use strict";function t(r,t,e){for(var n=(r.byteLength,0),i=e.length;i>n;n++){var o=e.charCodeAt(n);if(128>o)r.setUint8(t++,o>>>0&127|0);else if(2048>o)r.setUint8(t++,o>>>6&31|192),r.setUint8(t++,o>>>0&63|128);else if(65536>o)r.setUint8(t++,o>>>12&15|224),r.setUint8(t++,o>>>6&63|128),r.setUint8(t++,o>>>0&63|128);else{if(!(1114112>o))throw new Error("bad codepoint "+o);r.setUint8(t++,o>>>18&7|240),r.setUint8(t++,o>>>12&63|128),r.setUint8(t++,o>>>6&63|128),r.setUint8(t++,o>>>0&63|128)}}}function e(r){for(var t=0,e=0,n=r.length;n>e;e++){var i=r.charCodeAt(e);if(128>i)t+=1;else if(2048>i)t+=2;else if(65536>i)t+=3;else{if(!(1114112>i))throw new Error("bad codepoint "+i);t+=4}}return t}function n(r,i,o){var a=typeof r;if("string"===a){var u=e(r);if(32>u)return i.setUint8(o,160|u),t(i,o+1,r),1+u;if(256>u)return i.setUint8(o,217),i.setUint8(o+1,u),t(i,o+2,r),2+u;if(65536>u)return i.setUint8(o,218),i.setUint16(o+1,u),t(i,o+3,r),3+u;if(4294967296>u)return i.setUint8(o,219),i.setUint32(o+1,u),t(i,o+5,r),5+u}if(r instanceof ArrayBuffer){var u=r.byteLength;if(256>u)return i.setUint8(o,196),i.setUint8(o+1,u),new Uint8Array(i.buffer).set(new Uint8Array(r),o+2),2+u;if(65536>u)return i.setUint8(o,197),i.setUint16(o+1,u),new Uint8Array(i.buffer).set(new Uint8Array(r),o+3),3+u;if(4294967296>u)return i.setUint8(o,198),i.setUint32(o+1,u),new Uint8Array(i.buffer).set(new Uint8Array(r),o+5),5+u}if("number"===a){if(!isFinite(r))throw new Error("Number not finite: "+r);if(Math.floor(r)!==r)return i.setUint8(o,203),i.setFloat64(o+1,r),9;if(r>=0){if(128>r)return i.setUint8(o,r),1;if(256>r)return i.setUint8(o,204),i.setUint8(o+1,r),2;if(65536>r)return i.setUint8(o,205),i.setUint16(o+1,r),3;if(4294967296>r)return i.setUint8(o,206),i.setUint32(o+1,r),5;throw new Error("Number too big 0x"+r.toString(16))}if(r>=-32)return i.setInt8(o,r),1;if(r>=-128)return i.setUint8(o,208),i.setInt8(o+1,r),2;if(r>=-32768)return i.setUint8(o,209),i.setInt16(o+1,r),3;if(r>=-2147483648)return i.setUint8(o,210),i.setInt32(o+1,r),5;throw new Error("Number too small -0x"+(-r).toString(16).substr(1))}if(null===r)return i.setUint8(o,192),1;if("boolean"===a)return i.setUint8(o,r?195:194),1;if("object"===a){var u,s=0,f=Array.isArray(r);if(f)u=r.length;else{var c=Object.keys(r);u=c.length}var s;if(16>u?(i.setUint8(o,u|(f?144:128)),s=1):65536>u?(i.setUint8(o,f?220:222),i.setUint16(o+1,u),s=3):4294967296>u&&(i.setUint8(o,f?221:223),i.setUint32(o+1,u),s=5),f)for(var l=0;u>l;l++)s+=n(r[l],i,o+s);else for(var l=0;u>l;l++){var d=c[l];s+=n(d,i,o+s),s+=n(r[d],i,o+s)}return s}throw new Error("Unknown type "+a)}function i(r){var t=typeof r;if("string"===t){var n=e(r);if(32>n)return 1+n;if(256>n)return 2+n;if(65536>n)return 3+n;if(4294967296>n)return 5+n}if(r instanceof ArrayBuffer){var n=r.byteLength;if(256>n)return 2+n;if(65536>n)return 3+n;if(4294967296>n)return 5+n}if("number"===t){if(Math.floor(r)!==r)return 9;if(r>=0){if(128>r)return 1;if(256>r)return 2;if(65536>r)return 3;if(4294967296>r)return 5;throw new Error("Number too big 0x"+r.toString(16))}if(r>=-32)return 1;if(r>=-128)return 2;if(r>=-32768)return 3;if(r>=-2147483648)return 5;throw new Error("Number too small -0x"+r.toString(16).substr(1))}if("boolean"===t||null===r)return 1;if("object"===t){var n,o=0;if(Array.isArray(r)){n=r.length;for(var a=0;n>a;a++)o+=i(r[a])}else{var u=Object.keys(r);n=u.length;for(var a=0;n>a;a++){var s=u[a];o+=i(s)+i(r[s])}}if(16>n)return 1+o;if(65536>n)return 3+o;if(4294967296>n)return 5+o;throw new Error("Array or object too long 0x"+n.toString(16))}throw new Error("Unknown type "+t)}function o(r){var t=new ArrayBuffer(i(r)),e=new DataView(t);return n(r,e,0),new Uint8Array(t)}function a(r){return new Uint8Array(r.buffer,r.byteOffset,r.byteLength)}function u(r){return new Int8Array(r.buffer,r.byteOffset,r.byteLength)}function s(r,t){var e,n,i,o=(r.byteOffset,r.byteLength);for(t||(t=new Int16Array(o/2)),e=0,n=0,i=o/2;i>e;++e,n+=2)t[e]=r[n]<<8^r[n+1]<<0;return t}function f(r,t){var e=r.length;t||(t=new Uint8Array(2*e));for(var n=new DataView(t.buffer,t.byteOffset,t.byteLength),i=0;e>i;++i)n.setInt16(2*i,r[i]);return t.buffer}function c(r,t){var e,n,i,o=(r.byteOffset,r.byteLength);for(t||(t=new Int32Array(o/4)),e=0,n=0,i=o/4;i>e;++e,n+=4)t[e]=r[n]<<24^r[n+1]<<16^r[n+2]<<8^r[n+3]<<0;return t}function l(r){return new Int32Array(r.buffer,r.byteOffset,r.byteLength/4)}function d(r,t){var e=r.length;t||(t=new Uint8Array(4*e));for(var n=new DataView(t.buffer,t.byteOffset,t.byteLength),i=0;e>i;++i)n.setInt32(4*i,r[i]);return t.buffer}function g(r,t,e){var n=r.length,i=1/t;e||(e=new Float32Array(n));for(var o=0;n>o;++o)e[o]=r[o]*i;return e}function y(r,t,e,n){e||(e=4);var i=r.length,o=new ArrayBuffer(i*e),a=new DataView(o),u="setInt32";1===e?u="setInt8":2===e&&(u="setInt16");for(var s=0;i>s;++s)a[u](e*s,Math.round(r[s]*t),n);return o}function v(r,t){var e,n;if(!t){var i=0;for(e=0,n=r.length;n>e;e+=2)i+=r[e+1];t=new r.constructor(i)}var o=0;for(e=0,n=r.length;n>e;e+=2)for(var a=r[e],u=r[e+1],s=0;u>s;++s)t[o]=a,o+=1;return t}function h(r){if(0===r.length)return new ArrayBuffer;var t,e,n=2;for(t=1,e=r.length;e>t;++t)r[t-1]!==r[t]&&(n+=2);var i=new ArrayBuffer(4*n),o=new DataView(i),a=0,u=1;for(t=1,e=r.length;e>t;++t)r[t-1]!==r[t]?(o.setInt32(a,r[t-1]),o.setInt32(a+4,u),u=1,a+=8):u+=1;return o.setInt32(a,r[r.length-1]),o.setInt32(a+4,u),i}function U(r){for(var t=1,e=r.length;e>t;++t)r[t]+=r[t-1];return r}function w(r,t){t||(t=new r.constructor(r.length)),t[0]=r[0];for(var e=1,n=t.length;n>e;++e)t[e]=r[e]-r[e-1];return t}function m(r,t,e){var n=r.length/2+t.length;e||(e=new Int32Array(n));for(var i=0,o=0,a=0,u=r.length;u>a;a+=2){var s=r[a],f=r[a+1];e[i]=s,0!==a&&(e[i]+=e[i-1]),i+=1;for(var c=0;f>c;++c)e[i]=e[i-1]+t[o],i+=1,o+=1}return e}function L(r,t){var e,n,i=t?127:32767,o=t?Int8Array:Int16Array,a=w(r),u=0,s=0;for(e=0,n=a.length;n>e;++e){var c=a[e];c>i||-i>c?u+=2:s+=1}var l=new Int32Array(u),g=new o(s),y=0,v=0;for(e=0,n=a.length;n>e;++e){var c=a[e];c>i||-i>c?(l[y]=c,l[y+1]=0,y+=2):(g[v]=c,v+=1,l[y-1]+=1)}return[d(l,l),t?g:f(g,g)]}function b(r,t,e,n){var i=r.length/4/2+t.length/2;n||(n=new Float32Array(i));var o=l(n),a=m(c(r),s(t),o);return g(a,e,n)}function p(r,t,e){var n=new Int32Array(y(r,t,4,!0));return L(n,e)}function I(r,t,e){var n=e?l(e):void 0,i=v(c(r),n);return g(i,t,e)}function A(r){var t={};M.forEach(function(e){void 0!==r[e]&&(t[e]=r[e])});var e=p(r.xCoordList,1e3);t.xCoordBig=new Uint8Array(e[0]),t.xCoordSmall=new Uint8Array(e[1]);var n=p(r.yCoordList,1e3);t.yCoordBig=new Uint8Array(n[0]),t.yCoordSmall=new Uint8Array(n[1]);var i=p(r.zCoordList,1e3);return t.zCoordBig=new Uint8Array(i[0]),t.zCoordSmall=new Uint8Array(i[1]),t.groupIdList=new Uint8Array(h(w(r.groupIdList))),t.groupTypeList=new Uint8Array(d(r.groupTypeList)),t.chainIdList=r.chainIdList,t}function C(r){function t(r){for(var t={},e=0;r>e;e++){var n=o();t[n]=o()}return t}function e(t){var e=r.subarray(a,a+t);return a+=t,e}function n(t){var e=r.subarray(a,a+t);a+=t;var n=65535;if(t>n){for(var i=[],o=0;o<e.length;o+=n)i.push(String.fromCharCode.apply(null,e.subarray(o,o+n)));return i.join("")}return String.fromCharCode.apply(null,e)}function i(r){for(var t=new Array(r),e=0;r>e;e++)t[e]=o();return t}function o(){var o,s,f=r[a];if(0===(128&f))return a++,f;if(128===(240&f))return s=15&f,a++,t(s);if(144===(240&f))return s=15&f,a++,i(s);if(160===(224&f))return s=31&f,a++,n(s);if(224===(224&f))return o=u.getInt8(a),a++,o;switch(f){case 192:return a++,null;case 194:return a++,!1;case 195:return a++,!0;case 196:return s=u.getUint8(a+1),a+=2,e(s);case 197:return s=u.getUint16(a+1),a+=3,e(s);case 198:return s=u.getUint32(a+1),a+=5,e(s);case 202:return o=u.getFloat32(a+1),a+=5,o;case 203:return o=u.getFloat64(a+1),a+=9,o;case 204:return o=r[a+1],a+=2,o;case 205:return o=u.getUint16(a+1),a+=3,o;case 206:return o=u.getUint32(a+1),a+=5,o;case 208:return o=u.getInt8(a+1),a+=2,o;case 209:return o=u.getInt16(a+1),a+=3,o;case 210:return o=u.getInt32(a+1),a+=5,o;case 217:return s=u.getUint8(a+1),a+=2,n(s);case 218:return s=u.getUint16(a+1),a+=3,n(s);case 219:return s=u.getUint32(a+1),a+=5,n(s);case 220:return s=u.getUint16(a+1),a+=3,i(s);case 221:return s=u.getUint32(a+1),a+=5,i(s);case 222:return s=u.getUint16(a+1),a+=3,t(s);case 223:return s=u.getUint32(a+1),a+=5,t(s)}throw new Error("Unknown type 0x"+f.toString(16))}var a=0,u=new DataView(r.buffer);return o()}function x(r,t){function e(r){return n?-1===n.indexOf(r):!0}t=t||{};var n=t.ignoreFields,i=(r.numBonds||0,r.numAtoms||0),o=r.groupTypeList.length/4,s=r.chainIdList.length/4,f=r.chainsPerModel.length,l={numGroups:o,numChains:s,numModels:f};M.forEach(function(t){void 0!==r[t]&&(l[t]=r[t])});var d="bondAtomList";r[d]&&e(d)&&(l[d]=c(r[d]));var g="bondOrderList";r[g]&&e(g)&&(l[g]=a(r[g])),l.xCoordList=b(r.xCoordBig,r.xCoordSmall,1e3),l.yCoordList=b(r.yCoordBig,r.yCoordSmall,1e3),l.zCoordList=b(r.zCoordBig,r.zCoordSmall,1e3);var y="bFactorList",h="bFactorBig",w="bFactorSmall";r[h]&&r[w]&&e(y)&&(l[y]=b(r[h],r[w],100));var m="atomIdList";r[m]&&e(m)&&(l[m]=U(v(c(r[m]))));var L="altLocList";r[L]&&e(L)&&(l[L]=v(c(r[L]),new Uint8Array(i)));var p="occupancyList";r[p]&&e(p)&&(l[p]=I(r[p],100)),l.groupIdList=U(v(c(r.groupIdList))),l.groupTypeList=c(r.groupTypeList);var A="secStructList";r[A]&&e(A)&&(l[A]=u(r[A]));var C="insCodeList";r[C]&&e(C)&&(l[C]=v(c(r[C]),new Uint8Array(o)));var x="sequenceIndexList";r[x]&&e(x)&&(l[x]=U(v(c(r[x])))),l.chainIdList=a(r.chainIdList);var S="chainNameList";return r[S]&&e(S)&&(l[S]=a(r[S])),l}function S(r){return String.fromCharCode.apply(null,r).replace(/\0/g,"")}function B(r,t,e){e=e||{};var n,i,o,a,u,s,f=e.firstModelOnly,c=t.onModel,l=t.onChain,d=t.onGroup,g=t.onAtom,y=t.onBond,v=0,h=0,U=0,w=0,m=0,L=-1,b=r.chainNameList,p=r.secStructList,I=r.insCodeList,A=r.sequenceIndexList,C=r.atomIdList,x=r.bFactorList,B=r.altLocList,O=r.occupancyList,F=r.bondAtomList,M=r.bondOrderList;for(n=0,i=r.chainsPerModel.length;i>n&&!(f&&v>0);++n){var E=r.chainsPerModel[v];for(c&&c({chainCount:E,modelIndex:v}),o=0;E>o;++o){var N=r.groupsPerChain[h];if(l){var T=S(r.chainIdList.subarray(4*h,4*h+4)),z=null;b&&(z=S(b.subarray(4*h,4*h+4))),l({groupCount:N,chainIndex:h,modelIndex:v,chainId:T,chainName:z})}for(a=0;N>a;++a){var D=r.groupList[r.groupTypeList[U]],j=D.atomNameList.length;if(d){var P=null;p&&(P=p[U]);var V=null;r.insCodeList&&(V=String.fromCharCode(I[U]));var k=null;A&&(k=A[U]),d({atomCount:j,groupIndex:U,chainIndex:h,modelIndex:v,groupId:r.groupIdList[U],groupType:r.groupTypeList[U],groupName:D.groupName,singleLetterCode:D.singleLetterCode,chemCompType:D.chemCompType,secStruct:P,insCode:V,sequenceIndex:k})}for(u=0;j>u;++u){if(g){var q=null;C&&(q=C[w]);var G=null;x&&(G=x[w]);var W=null;B&&(W=String.fromCharCode(B[w]));var H=null;O&&(H=O[w]),g({atomIndex:w,groupIndex:U,chainIndex:h,modelIndex:v,atomId:q,element:D.elementList[u],atomName:D.atomNameList[u],atomCharge:D.atomChargeList[u],xCoord:r.xCoordList[w],yCoord:r.yCoordList[w],zCoord:r.zCoordList[w],bFactor:G,altLoc:W,occupancy:H})}w+=1}if(y){var J=D.bondAtomList;for(u=0,s=D.bondOrderList.length;s>u;++u)y({atomIndex1:w-j+J[2*u],atomIndex2:w-j+J[2*u+1],bondOrder:D.bondOrderList[u]})}U+=1}h+=1}if(m=L+1,L=w-1,y&&F)for(u=0,s=F.length;s>u;u+=2){var K=F[u],Q=F[u+1];(K>=m&&L>=K||Q>=m&&L>=Q)&&y({atomIndex1:K,atomIndex2:Q,bondOrder:M?M[u/2]:null})}v+=1}}function O(r){return o(A(r))}function F(r,t){r instanceof ArrayBuffer&&(r=new Uint8Array(r));var e;return e=r instanceof Uint8Array?C(r):r,x(e,t)}var M=["mmtfVersion","mmtfProducer","unitCell","spaceGroup","structureId","title","depositionDate","releaseDate","experimentalMethods","resolution","rFree","rWork","bioAssemblyList","entityList","groupList","numBonds","numAtoms","groupsPerChain","chainsPerModel"],E="v0.2.3";r.encode=O,r.decode=F,r.traverse=B,r.version=E});