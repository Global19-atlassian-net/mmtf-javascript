<!DOCTYPE html>
<html lang="en">

<head>

    <title>MMTF Multi File Stats</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

</head>

<body>

    <script src="utils.js"></script>
    <script src="../test/polyfills.js"></script>

    <script>

        var fullPdbIdList = [];
        var currentStats = {};
        var currentErrors = {};
        var currentStatus = {};
        var currentAvg = {};
        var currentSum = {};
        var worker = new Worker( "worker.js" );

        document.addEventListener( "DOMContentLoaded", function(){
            $( "backboneOnlyInput" ).addEventListener( "change", function(){
                loadRandom( $( "countSelect" ).value, backboneOnlyInput.checked );
            } );
            $( "loadButton" ).addEventListener( "click", function(){
                loadRandom( $( "countSelect" ).value, backboneOnlyInput.checked );
            } );
            $( "downloadStats" ).addEventListener( "click", function(){
                downloadStats( currentStats, true );
            } );
            $( "downloadErrors" ).addEventListener( "click", function(){
                downloadErrors( currentErrors );
            } );
            $( "downloadSummary" ).addEventListener( "click", function(){
                downloadSummary( currentStatus, currentAvg, currentSum );
            } );
            loadPdbIdList();
        } );

        function getRandomPdbIdList( count, list ){
            var pdbIdList;
            list = list || fullPdbIdList
            if( count === "all" || count === list.length ){
                pdbIdList = list;
            }else{
                pdbIdList = [];
                for( var i = 0; i < count; ++i ){
                    var index = Math.floor( Math.random() * list.length );
                    pdbIdList.push( list[ index ] );
                }
            }
            return pdbIdList;
        }

        function loadPdbIdList(){
            var xhr = new XMLHttpRequest();
            xhr.open( "GET", "http://www.rcsb.org/pdb/json/getCurrent", true );
            xhr.responseType = "json";
            xhr.addEventListener( "load", function(){
                console.log( "loaded list with " + this.response.idList.length + " pdb ids" );
                fullPdbIdList = this.response.idList;
            }, true );
            xhr.addEventListener( "error", function(){
                console.error( "error loading pdb id list" )
            }, true );
            xhr.send();
        }

        function loadRandom( count, backboneOnly ){
            var pdbIdList = getRandomPdbIdList( count, fullPdbIdList );
            load( pdbIdList, backboneOnly );
        }

        function load( pdbIdList, backboneOnly ){
            $( "downloads" ).style.display = "none";
            $( "statusInfo" ).innerText = "0 of " + pdbIdList.length + " (0 failed) -- 0.00ms";
            worker.postMessage( {
                pdbIdList: pdbIdList,
                backboneOnly: backboneOnly
            } );
        }

        worker.onmessage = function( e ){
            if( e.data.status === undefined ){
                console.log( "onmessage", e.data );
                return;
            }
            var status = e.data.status;
            $( "statusInfo" ).innerText = (
                status.finished + " of " + status.requested +
                " (" + status.failed + " failed) -- " + formatMilliseconds( status.timeMs )
            );
            var statsList = e.data.statsList;
            var sumStats = { type: "sum", count: statsList.length, overallTimeMs: status.timeMs };
            var countList = [
                "numBonds", "numAtoms", "numGroups", "numChains", "numModels"
            ];
            var nameList = [
                "msgpackByteLength", "coordByteLength", "bfactorByteLength",
                "decodeTimeMs", "decodeMsgpackTimeMs", "decodeMmtfTimeMs",
                "msgpackBytesPerAtom"
            ].concat( countList );
            nameList.forEach( function( name ){
                sumStats[ name ] = 0;
            } );
            statsList.forEach( function( stats ){
                nameList.forEach( function( name ){
                    sumStats[ name ] += stats[ name ];
                } );
            } );
            var sumStatsPrint = Object.assign( {}, sumStats );
            var avgStats = Object.assign( {}, sumStats, { type: "average" } );
            nameList.forEach( function( name ){
                avgStats[ name ] /= statsList.length;
            } );
            avgStats.overallTimeMs /= statsList.length;
            var avgStatsPrint = Object.assign( {}, avgStats );
            countList.forEach( function( name ){
                avgStatsPrint[ name ] = avgStatsPrint[ name ].toFixed( 2 );
            } );
            delete sumStats.msgpackBytesPerAtom;
            delete sumStatsPrint.msgpackBytesPerAtom;
            showStats( avgStatsPrint, "avgStats" );
            showStats( sumStatsPrint, "sumStats" );
            if( status.requested === ( status.finished + status.failed ) ){
                $( "statsListJson" ).innerText = JSON.stringify( e.data.statsList, null, '\t' );
                $( "statsSumJson" ).innerText = JSON.stringify( sumStats, null, '\t' );
                $( "statsAvgJson" ).innerText = JSON.stringify( avgStats, null, '\t' );
                $( "errorsJson" ).innerText = JSON.stringify( e.data.errors, null, '\t' );
                currentStats = e.data.statsList;
                currentErrors = e.data.errors;
                currentStatus = e.data.status;
                currentAvg = avgStats;
                currentSum = sumStats;
                $( "downloads" ).style.display = "block";
            }
        };

    </script>

    <span style="display:none;" id="statusJson"></span>
    <span style="display:none;" id="statsListJson"></span>
    <span style="display:none;" id="statsSumJson"></span>
    <span style="display:none;" id="statsAvgJson"></span>
    <span style="display:none;" id="errorsJson"></span>

    <div>
        Count
        <select name="count" id="countSelect">
            <option value="1">1</option>
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="50" selected>50</option>
            <option value="100">100</option>
            <option value="500">500</option>
            <option value="1000">1000</option>
            <option value="5000">5000</option>
            <option value="10000">10000</option>
            <option value="50000">50000</option>
            <option value="100000">100000</option>
            <option value="all">all</option>
        </select>
        <button id="loadButton">load</button>
        <input type="checkbox" id="backboneOnlyInput"></input>Backbone only
    </div>

    <br/>

    <div style="display:none;" id="downloads">
        Downloads
        <button id="downloadStats">stats</button>
        <button id="downloadErrors">errors</button>
        <button id="downloadSummary">summary</button>
    </div>

    <br/>

    <div>
        Status
        <span id="statusInfo"></span>
    </div>

    <br/>

    <div id="avgStats"></div>

    <br/>

    <div id="sumStats"></div>

</body>

</html>
