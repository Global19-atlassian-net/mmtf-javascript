<!DOCTYPE html>
<html lang="en">

<head>

    <title>MMTF Multi File Stats</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

</head>

<body>

    <script src="utils.js"></script>
    <script src="../test/polyfills.js"></script>

    <script>

        var fullPdbIdList = [];
        var worker = new Worker( "worker.js" );

        document.addEventListener( "DOMContentLoaded", function(){
            var countSelect = $( "countSelect" );
            var cAlphaOnlyInput = $( "cAlphaOnlyInput" );
            cAlphaOnlyInput.addEventListener( "change", function(){
                loadRandom( countSelect.value, cAlphaOnlyInput.checked );
            } );
            var loadButton = document.getElementById( "loadButton" );
            loadButton.addEventListener( "click", function(){
                loadRandom( countSelect.value, cAlphaOnlyInput.checked );
            } );
            loadPdbIdList();
        } );

        function getRandomPdbIdList( count, list ){
            var pdbIdList;
            if( count === "all" || count === list.length ){
                pdbIdList = fullPdbIdList;
            }else{
                pdbIdList = [];
                for( var i = 0; i < count; ++i ){
                    var index = Math.floor( Math.random() * fullPdbIdList.length );
                    pdbIdList.push( fullPdbIdList[ index ] );
                }
            }
            return pdbIdList;
        }

        function loadPdbIdList(){
            var xhr = new XMLHttpRequest();
            xhr.open( "GET", "http://www.rcsb.org/pdb/json/getCurrent", true );
            // xhr.responseType = "json";  // not supported in phantomjs
            xhr.addEventListener( "load", function(){
                var response = JSON.parse( this.response );
                console.log( "loaded list with " + response.idList.length + " pdb ids" );
                fullPdbIdList = response.idList;
                // var count = GET( "count" );
                // if( count ){
                //     loadRandom( parseInt( count ), GET( "cAlphaOnly" ) ? true : false );
                // }
            }, true );
            xhr.addEventListener( "error", function(){
                console.error( "error loading pdb id list" )
            }, true );
            xhr.send();
        }

        function loadRandom( count, cAlphaOnly ){
            var pdbIdList = getRandomPdbIdList( count, fullPdbIdList );
            load( pdbIdList, cAlphaOnly );
        }

        function load( pdbIdList, cAlphaOnly ){
            var statusInfo = $( "statusInfo" );
            statusInfo.innerText = "0 of " + pdbIdList.length + " (0 failed) -- 0.00ms";
            worker.postMessage( {
                pdbIdList: pdbIdList,
                cAlphaOnly: cAlphaOnly
            } );
        }

        worker.onmessage = function( e ){
            if( e.data.status === undefined ){
                console.log("onmessage",e.data)
                return;
            }
            var status = e.data.status;
            status.time = formatMilliseconds( status.timeMs );
            delete status.timeMs;
            var statusJson = $( "statusJson" );
            statusJson.innerText = JSON.stringify( status );
            var statusInfo = $( "statusInfo" );
            statusInfo.innerText = (
                status.finished + " of " + status.requested +
                " (" + status.failed + " failed) -- " + status.time
            );
            var statsList = e.data.statsList;
            var sumStats = { type: "sum", count: statsList.length };
            var countList = [
                "numBonds", "numAtoms", "numGroups", "numChains", "numModels"
            ];
            var nameList = [
                "msgpackByteLength", "coordByteLength", "bfactorByteLength",
                "decodeTimeMs", "decodeMsgpackTimeMs", "decodeMmtfTimeMs",
                "msgpackBytesPerAtom"
            ].concat( countList );
            nameList.forEach( function( name ){
                sumStats[ name ] = 0;
            } );
            statsList.forEach( function( stats ){
                nameList.forEach( function( name ){
                    sumStats[ name ] += stats[ name ];
                } );
            } );
            var avgStats = Object.assign( {}, sumStats, { type: "average" } );
            nameList.forEach( function( name ){
                avgStats[ name ] /= statsList.length;
            } );
            countList.forEach( function( name ){
                avgStats[ name ] = avgStats[ name ].toFixed( 2 );
            } );
            delete sumStats.msgpackBytesPerAtom;
            showStats( avgStats, "avgStats" );
            showStats( sumStats, "sumStats" );
            if( status.requested === ( status.finished + status.failed ) ){
                $( "statsListJson" ).innerText = JSON.stringify( e.data.statsList, null, '\t' );
                $( "statsSumJson" ).innerText = JSON.stringify( sumStats, null, '\t' );
                $( "statsAvgJson" ).innerText = JSON.stringify( avgStats, null, '\t' );
                $( "errorsJson" ).innerText = JSON.stringify( e.data.errors, null, '\t' );
            }
        };

    </script>

    <span style="display:none;" id="statusJson"></span>
    <span style="display:none;" id="statsListJson"></span>
    <span style="display:none;" id="statsSumJson"></span>
    <span style="display:none;" id="statsAvgJson"></span>
    <span style="display:none;" id="errorsJson"></span>

    <div>
        Count
        <select name="count" id="countSelect">
            <option value="1">1</option>
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="50" selected>50</option>
            <option value="100">100</option>
            <option value="500">500</option>
            <option value="1000">1000</option>
            <option value="5000">5000</option>
            <option value="10000">10000</option>
            <option value="50000">50000</option>
            <option value="100000">100000</option>
            <option value="all">all</option>
        </select>
        <button id="loadButton">load</button>
        <input type="checkbox" id="cAlphaOnlyInput"></input>C-alpha only
    </div>

    <br/>

    <div>
        Status
        <span id="statusInfo"></span>
    </div>

    <br/>

    <div id="avgStats"></div>

    <br/>

    <div id="sumStats"></div>

</body>

</html>
