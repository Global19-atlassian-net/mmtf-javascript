<!DOCTYPE html>
<html lang="en">

<head>

    <title>MMTF Single File Stats</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

</head>

<body>

    <script src="utils.js"></script>
    <script src="../build/structure-decoder.js"></script>

    <script>

        var currentStructureHelper;

        function onload(){
            if( this.status === 200 || this.status === 304 || this.status === 0 ){
                var t0 = performance.now();
                var ds = decodeStructure( this.response );
                var t1 = performance.now();
                var info = {
                    msgpackByteLength: this.response.byteLength,
                    decodeTimeMs: t1 - t0
                };
                currentStructureHelper = new StructureHelper( ds );
                showStats( getStats( currentStructureHelper, info ), "stats" );
                showRandomAtomInfo( currentStructureHelper, "atomInfo" );
            }else{
                error( "error loading" );
            }
        }

        function clear(){
            document.getElementById( "stats" ).innerHTML = "";
            document.getElementById( "atomInfo" ).innerHTML = "";
        }

        function error( msg ){
            document.getElementById( "stats" ).innerHTML = msg || error;
            document.getElementById( "atomInfo" ).innerHTML = "";
        }

        function loadStructure( pdbid, cAlphaOnly ){
            var xhr = new XMLHttpRequest();
            xhr.addEventListener( "load", onload, true );
            xhr.addEventListener( "error", function(){ error( "error loading" ) }, true );
            xhr.responseType = "arraybuffer";
            xhr.open( "GET", "../data/1aq1.mmtf" );
            // xhr.open( "GET", getMmtfUrl( pdbid, cAlphaOnly ) );
            xhr.send();
        }

        document.addEventListener( "DOMContentLoaded", function(){

            var cAlphaOnlyInput = document.getElementById( "cAlphaOnlyInput" );
            cAlphaOnlyInput.addEventListener( "change", function(){
                if( pdbidInput.value ){
                    pdbidSelect.value = "";
                    loadStructure( pdbidInput.value, cAlphaOnlyInput.checked );
                }else{
                    loadStructure( pdbidSelect.value, cAlphaOnlyInput.checked );
                }
            } );

            var pdbidSelect = document.getElementById( "pdbidSelect" );
            pdbidSelect.addEventListener( "change", function(){
                if( pdbidSelect.value ){
                    pdbidInput.value = "";
                    loadStructure( pdbidSelect.value, cAlphaOnlyInput.checked );
                }else{
                    clear();
                }
            } );

            var pdbidInput = document.getElementById( "pdbidInput" );
            pdbidInput.addEventListener( "keypress", function( e ){
                if( e.keyCode === 13 ){
                    if( pdbidInput.value ){
                        pdbidSelect.value = "";
                        loadStructure( pdbidInput.value, cAlphaOnlyInput.checked );
                    }else{
                        clear();
                    }
                }
            } );

            var pdbidButton = document.getElementById( "pdbidButton" );
            pdbidButton.addEventListener( "click", function(){
                if( pdbidInput.value ){
                    pdbidSelect.value = "";
                    loadStructure( pdbidInput.value, cAlphaOnlyInput.checked );
                }else{
                    loadStructure( pdbidSelect.value, cAlphaOnlyInput.checked );
                }
            } );

            var atomInfoButton = document.getElementById( "atomInfoButton" );
            atomInfoButton.addEventListener( "click", function(){
                showRandomAtomInfo( currentStructureHelper, "atomInfo" );
            } );

            loadStructure( pdbidSelect.value, cAlphaOnlyInput.checked );

        } );

    </script>

    <div>
        PDB ID
        <select name="pdbid" id="pdbidSelect">
            <option value=""></option>
            <option value="4CUP">4CUP</option>
            <option value="3SN6" selected>3SN6</option>
            <option value="2L6N">2L6N</option>
            <option value="4V5A">4V5A</option>
            <option value="4V99">4V99</option>
            <option value="4P3Q">4P3Q</option>
            <option value="3J3Q">3J3Q</option>
            <option value="3J3Y">3J3Y</option>
        </select>
        <input type="text" id="pdbidInput"></input>
        <button id="pdbidButton">get</button>
        <input type="checkbox" id="cAlphaOnlyInput"></input>C-alpha only
    </div>

    <br/>

    <div id="stats"></div>

    <br/>

    <div>
        Random Atom Info
        <button id="atomInfoButton">show</button>
    </div>

    <br/>

    <div id="atomInfo"></div>

</body>

</html>
