<!DOCTYPE html>
<html lang="en">

<head>

    <title>Stats</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

</head>

<body>

    <script src="utils.js"></script>
    <script src="../lib/bops.js"></script>
    <script src="../lib/msgpack.js"></script>
    <script src="../src/decoder.js"></script>

    <script>

        var currentStructureDecoder;

        function onload(){
            if( this.status === 200 || this.status === 304 || this.status === 0 ){
                var sd = new StructureDecoder( this.response );
                sd.decode();
                currentStructureDecoder = sd;
                // console.log( sd );
                showStats( sd, "stats" );
                showRandomAtomInfo( sd, "atomInfo" );
            }else{
                error( "error loading" );
            }
        }

        function clear(){
            document.getElementById( "stats" ).innerHTML = "";
            document.getElementById( "atomInfo" ).innerHTML = "";
        }

        function error( msg ){
            document.getElementById( "stats" ).innerHTML = msg || error;
            document.getElementById( "atomInfo" ).innerHTML = "";
        }

        function loadStructure( pdbid ){
            pdbid = pdbid.toUpperCase();
            var xhr = new XMLHttpRequest();
            xhr.addEventListener( "load", onload, true );
            xhr.addEventListener( "error", function(){ error( "error loading" ) }, true );
            xhr.responseType = "arraybuffer";
            xhr.open( "GET", "http://132.249.213.67:8080/servemessagepack/" + pdbid );
            xhr.send();
        }

        document.addEventListener( "DOMContentLoaded", function(){

            var pdbidSelect = document.getElementById( "pdbidSelect" );
            pdbidSelect.addEventListener( "change", function(){
                if( pdbidSelect.value ){
                    pdbidInput.value = "";
                    loadStructure( pdbidSelect.value );
                }else{
                    clear();
                }
            } );

            var pdbidInput = document.getElementById( "pdbidInput" );
            pdbidInput.addEventListener( "keypress", function( e ){
                if( e.keyCode === 13 ){
                    if( pdbidInput.value ){
                        pdbidSelect.value = "";
                        loadStructure( pdbidInput.value );
                    }else{
                        clear();
                    }
                }
            } );

            var pdbidButton = document.getElementById( "pdbidButton" );
            pdbidButton.addEventListener( "click", function(){
                if( pdbidInput.value ){
                    pdbidSelect.value = "";
                    loadStructure( pdbidInput.value );
                }else{
                    clear();
                }
            } );

            var atomInfoButton = document.getElementById( "atomInfoButton" );
            atomInfoButton.addEventListener( "click", function(){
                showRandomAtomInfo( currentStructureDecoder, "atomInfo" );
            } );

            loadStructure( pdbidSelect.value );

        } );

    </script>

    <div>
        PDB ID
        <select name="pdbid" id="pdbidSelect">
            <option value=""></option>
            <option value="4CUP" selected>4CUP</option>
            <option value="3SN6">3SN6</option>
            <option value="2L6N">2L6N</option>
            <option value="4V5A">4V5A</option>
            <option value="4V99">4V99</option>
            <option value="4P3Q">4P3Q</option>
        </select>
        <input type="text" id="pdbidInput"></input>
        <button id="pdbidButton">get</button>
    </div>

    <br/>

    <div>
        Random Atom Info
        <button id="atomInfoButton">show</button>
    </div>

    <br/>

    <div id="stats"></div>

    <br/>

    <div id="atomInfo"></div>

</body>

</html>
